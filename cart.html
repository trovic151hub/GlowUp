<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Shopping Cart</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
  <style>
    * {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }

    @import url('https://fonts.googleapis.com/css2?family=Lora:wght@700&family=Montserrat:wght@500&display=swap');

    /* ðŸ“± Mobile First Adjustments */
    @media (max-width: 640px) {
      header h1 {
        font-size: 1.1rem !important;
      }

      main {
        padding: 1rem !important;
      }

      /* Cart item layout vertical */
      .cart-item {
        @apply flex flex-col items-start gap-3 !important;
      }

      .cart-img {
        width: 64px !important;
        height: 64px !important;
      }

      .cart-title {
        font-size: 0.85rem !important;
      }

      .cart-price {
        font-size: 0.9rem !important;
      }

      .cart-qty button,
      .cart-qty span {
        font-size: 0.85rem !important;
      }

      #checkoutBtn {
        width: 100%;
        padding: 0.5rem !important;
        font-size: 1rem !important;
      }

      .total-box {
        text-align: center !important;
      }

      .shop {
        display: none !important;
      }
    }

    /* Very Small Phones */
    @media (max-width: 380px) {
      header h1 {
        font-size: 1rem !important;
      }
      header a {
        font-size: 0.8rem !important;
      }
      .cart-title {
        font-size: 0.75rem !important;
      }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- Notification Container -->
<div id="notification-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>

  <header class="bg-gradient-to-r from-[#fbcfe8] to-[#f9a8d4] p-4 shadow-md flex justify-between items-center">
    <button onclick="history.back()">
      <h1 class="text-xl font-bold">ðŸ›’ My Cart</h1>
    </button>
    <button onclick="history.back()">
      <div class="flex space-x-2">
        <a href="products.html"><i class="fas fa-shop mt-1"></i></a>
        <a href="products.html" class="shop text-pink-600 font-bold">Continue Shopping</a>
      </div>
    </button>
  </header>

  <main class="p-6 max-w-4xl mx-auto">
    <!-- Cart Skeletons (hidden by default) -->
    <div id="cartSkeleton" class="space-y-4">
      <div class="flex items-center justify-between bg-white p-4 rounded shadow animate-pulse cart-item">
        <div class="flex items-center gap-4">
          <div class="w-16 h-16 bg-gray-200 rounded cart-img"></div>
          <div>
            <div class="w-32 h-4 bg-gray-200 mb-2 rounded cart-title"></div>
            <div class="w-20 h-4 bg-gray-200 rounded cart-price"></div>
          </div>
        </div>
        <div class="flex items-center gap-2 cart-qty">
          <div class="w-6 h-4 bg-gray-200 rounded"></div>
          <div class="w-8 h-4 bg-gray-200 rounded"></div>
          <div class="w-6 h-4 bg-gray-200 rounded"></div>
        </div>
        <div class="text-right total-box">
          <div class="w-16 h-4 bg-gray-200 mb-2 rounded"></div>
          <div class="w-12 h-4 bg-gray-200 rounded"></div>
        </div>
      </div>
    </div>

    <div id="cartContainer" class="space-y-4"></div>

    <div class="text-right mt-6">
      <h2 class="text-xl font-semibold mb-2">Total: â‚¦<span id="totalPrice">0</span></h2>
      <a href="checkout.html">
        <button id="checkoutBtn" class="bg-pink-500 text-white px-6 py-2 rounded hover:bg-pink-600">Checkout</button>
      </a>
    </div>
  </main>

<!-- Firebase Compat Scripts -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
(function(){
  // --- SINGLE Firebase App config (same as home/admin) ---
  const firebaseConfig = {
    apiKey: "AIzaSyDdTPmpaIPWSDWOmR-fXgvAb7hoxZUawcc",
    authDomain: "e-commerce-39c74.firebaseapp.com",
    projectId: "e-commerce-39c74",
    storageBucket: "e-commerce-39c74.firebasestorage.app",
    messagingSenderId: "863375033754",
    appId: "1:863375033754:web:7ba248c8dbb1566c83e623"
  };

  if (!window.firebase) {
    console.error("Firebase not loaded. Ensure firebase scripts are included on the page.");
    return;
  }

  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }

  const userAuth = firebase.auth();
  const userDb = firebase.firestore();

  // State
  let currentUser = null;
  let cartUnsub = null;

  // Elements (gracefully handle missing)
  const cartContainer = document.getElementById("cartContainer");
  const cartSkeleton  = document.getElementById("cartSkeleton");
  const totalSpan     = document.getElementById("totalPrice");
  const checkoutBtn   = document.getElementById("checkoutBtn");

  // Small helper: safely toggle element class
  function showElem(el){ if(!el) return; el.classList.remove('hidden'); }
  function hideElem(el){ if(!el) return; el.classList.add('hidden'); }

  // ---------- NOTIFICATIONS ----------
const activeNotifications = new Set();

function showNotification(message, type="info", duration=3000){
  let container = document.getElementById("notification-container");
  if(!container){
    container = document.createElement("div");
    container.id = "notification-container";
    container.className = "fixed top-4 right-4 z-50 flex flex-col gap-2";
    document.body.appendChild(container);
  }

  if(activeNotifications.has(message)) return; // prevent duplicates
  activeNotifications.add(message);

  const notif = document.createElement("div");
  notif.className = `
    flex items-center justify-between gap-3 p-4 bg-white rounded-lg shadow-lg
    border border-gray-200 min-w-[250px] max-w-sm
    animate-slideIn
  `;

  const icon = document.createElement("span");
  if(type==="success") icon.innerHTML=`<i class="fas fa-check-circle text-green-500 text-xl"></i>`;
  else if(type==="error") icon.innerHTML=`<i class="fas fa-times-circle text-red-500 text-xl"></i>`;
  else if(type==="warning") icon.innerHTML=`<i class="fas fa-exclamation-triangle text-yellow-500 text-xl"></i>`;
  else icon.innerHTML=`<i class="fas fa-info-circle text-blue-500 text-xl"></i>`;

  const text = document.createElement("span");
  text.className="flex-1 text-gray-800 font-medium";
  text.textContent = message;

  const closeBtn = document.createElement("button");
  closeBtn.innerHTML = "&times;";
  closeBtn.className = "ml-4 text-gray-400 hover:text-gray-600 font-bold text-lg";
  closeBtn.onclick = () => removeNotification(notif, message);

  notif.appendChild(icon);
  notif.appendChild(text);
  notif.appendChild(closeBtn);
  container.appendChild(notif);

  setTimeout(()=> removeNotification(notif, message), duration);
}

function removeNotification(notif, message){
  if(!notif) return;
  notif.classList.remove("animate-slideIn");
  notif.classList.add("animate-slideOut");
  notif.addEventListener("animationend", ()=> notif.remove());
  activeNotifications.delete(message);
}

// ---------- Notification Styles ----------
const style = document.createElement("style");
style.textContent = `
#notification-container {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  position: fixed;
  top: 1rem;
  right: 1rem;
  z-index: 9999;
}
@media (max-width: 640px) {
  #notification-container {
    top: 7%;
    left: 50%;
    right: auto;
    transform: translate(-50%, -50%);
    align-items: center;
    width: 90%;
  }
  #notification-container > div {
    width: 100%;
    max-width: 300px;
  }
}
@keyframes slideIn {
  from { opacity: 0; transform: translateX(50px); }
  to { opacity: 1; transform: translateX(0); }
}
.animate-slideIn { animation: slideIn 0.3s ease-out forwards; }

@keyframes slideOut {
  from { opacity: 1; transform: translateX(0); }
  to { opacity: 0; transform: translateX(50px); }
}
.animate-slideOut { animation: slideOut 0.3s ease-in forwards; }
`;
document.head.appendChild(style);

  // Start / stop cart listener
  function startCartListener(){
    stopCartListener();
    if (!currentUser) return;

    if (cartSkeleton) hideElem(cartSkeleton); // show skeleton initially removed then shown below
    if (cartSkeleton) showElem(cartSkeleton);
    if (cartContainer) cartContainer.innerHTML = "";

    const itemsRef = userDb.collection("carts").doc(currentUser.uid).collection("items").orderBy("createdAt","asc");

    cartUnsub = itemsRef.onSnapshot(snapshot => {
      const cartItems = snapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));
      if (cartSkeleton) hideElem(cartSkeleton);
      renderCart(cartItems);
    }, error => {
      if (cartSkeleton) hideElem(cartSkeleton);
      console.error("Cart listener error:", error);
      showNotification("Failed to load cart", "error");
      renderCart([]);
    });
  }

  function stopCartListener(){
    if (cartUnsub) {
      try { cartUnsub(); } catch(e){ console.warn("Failed to unsubscribe cart listener", e); }
      cartUnsub = null;
    }
  }

  // Render cart
  function renderCart(items = []){
    if (!cartContainer) return;

    cartContainer.innerHTML = "";
    let total = 0;

    if (!currentUser || items.length === 0) {
      cartContainer.innerHTML = `<p class="text-center text-gray-500">Your cart is empty.</p>`;
      if (totalSpan) totalSpan.textContent = "0";
      if (checkoutBtn) {
        checkoutBtn.disabled = true;
        checkoutBtn.classList.add("opacity-50","cursor-not-allowed");
      }
      return;
    }

    items.forEach(it => {
      const lineTotal = (it.price || 0) * (it.quantity || 0);
      total += lineTotal;

      // Create card
      const div = document.createElement("div");
      div.className = "flex items-center justify-between bg-white p-4 rounded shadow mb-3";

      // Use safe fallback values
      const imgSrc = it.image || 'https://via.placeholder.com/64';
      const name = escapeHtml(it.name || 'Item');
      const priceText = `â‚¦${Number(it.price || 0).toLocaleString()}`;

      div.innerHTML = `
        <div class="flex items-center gap-4">
          <img src="${imgSrc}" class="w-16 h-16 object-cover rounded" alt="${name}">
          <div>
            <h4 class="font-semibold">${name}</h4>
            <p class="text-pink-500 font-bold">${priceText}</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button data-action="minus" data-id="${it.docId}" class="px-2 bg-gray-200 flex items-center justify-center gap-1">
            <span>âˆ’</span>
            <svg data-spinner="minus-${it.docId}" class="w-4 h-4 text-pink-500 animate-spin hidden" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path></svg>
          </button>
          <span class="w-8 text-center" id="qty-${it.docId}">${it.quantity}</span>
          <button data-action="plus" data-id="${it.docId}" class="px-2 bg-gray-200 flex items-center justify-center gap-1">
            <span>+</span>
            <svg data-spinner="plus-${it.docId}" class="w-4 h-4 text-pink-500 animate-spin hidden" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path></svg>
          </button>
        </div>
        <div class="text-right">
          <p class="font-semibold">â‚¦${lineTotal.toLocaleString()}</p>
          <button data-action="remove" data-id="${it.docId}" class="text-red-600 text-sm flex items-center gap-1 hover:underline">
            <span>Remove</span>
            <svg data-spinner="remove-${it.docId}" class="w-4 h-4 text-pink-500 animate-spin hidden" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path></svg>
          </button>
        </div>
      `;

      cartContainer.appendChild(div);

      // wire up controls
      const minusBtn = div.querySelector('button[data-action="minus"]');
      const plusBtn  = div.querySelector('button[data-action="plus"]');
      const removeBtn= div.querySelector('button[data-action="remove"]');

      minusBtn && (minusBtn.onclick = () => updateQtyWithSpinner(it.docId, -1, `minus-${it.docId}`));
      plusBtn  && (plusBtn.onclick  = () => updateQtyWithSpinner(it.docId,  1, `plus-${it.docId}`));
      removeBtn&& (removeBtn.onclick= () => removeWithSpinner(it.docId, `remove-${it.docId}`));
    });

    // Update subtotal & checkout state
    if (totalSpan) totalSpan.textContent = total.toLocaleString();
    if (checkoutBtn) {
      checkoutBtn.disabled = false;
      checkoutBtn.classList.remove("opacity-50","cursor-not-allowed");
    }
  }

  // Helper to toggle spinner visibility by spinner data attribute key
  function toggleSpinner(spinnerKey, show = true) {
    const svg = document.querySelector(`[data-spinner="${spinnerKey}"]`);
    if (!svg) return;
    if (show) svg.classList.remove("hidden");
    else svg.classList.add("hidden");
  }

  // Update quantity using a Firestore transaction
  async function updateQtyWithSpinner(docId, delta, spinnerKey) {
    if (!currentUser) return showNotification("Login required", "error");
    toggleSpinner(spinnerKey, true);

    const itemRef = userDb.collection("carts").doc(currentUser.uid).collection("items").doc(docId);
    try {
      await userDb.runTransaction(async (t) => {
        const doc = await t.get(itemRef);
        if (!doc.exists) throw new Error("Item missing");
        const currentQty = doc.data().quantity || 0;
        const newQty = currentQty + delta;
        if (newQty <= 0) {
          t.delete(itemRef);
        } else {
          t.update(itemRef, { quantity: newQty });
        }
      });
      // Success feedback (UI updates will come from snapshot listener)
    } catch (err) {
      console.error("Quantity update failed:", err);
      showNotification("Quantity update failed", "error");
    } finally {
      toggleSpinner(spinnerKey, false);
    }
  }

  // Remove item
  function removeWithSpinner(docId, spinnerKey) {
    if (!currentUser) return showNotification("Login required", "error");
    toggleSpinner(spinnerKey, true);

    userDb.collection("carts").doc(currentUser.uid).collection("items").doc(docId)
      .delete()
      .then(()=> showNotification("Item removed", "success"))
      .catch(err => {
        console.error("Remove failed:", err);
        showNotification("Remove failed", "error");
      })
      .finally(()=> toggleSpinner(spinnerKey, false));
  }

  // Checkout button behaviour - simple redirect to checkout page (you can expand)
  if (checkoutBtn) {
    checkoutBtn.addEventListener("click", async (e) => {
      e.preventDefault();
      if (!currentUser) {
        showNotification("Please log in to checkout", "warning");
        // if you have a login modal: open it here (e.g. openLoginModal())
        return;
      }
      // Optional: validate cart non-empty client-side (server listener will enforce).
      // Redirect to your checkout page
      window.location.href = "checkout.html";
    });
  }

  // Auth listener to start/stop cart
  userAuth.onAuthStateChanged(user => {
    currentUser = user;
    if (user) {
      startCartListener();
    } else {
      stopCartListener();
      if (cartSkeleton) hideElem(cartSkeleton);
      renderCart([]);
    }
  });

  // Small escape helper
  function escapeHtml(text){ if(text==null) return ''; return String(text).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // Expose for debugging if needed
  window._cart = { startCartListener, stopCartListener };

})();
</script>
</body>
</html>