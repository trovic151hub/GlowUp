<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Shopping Cart</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
  <style>
    * {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }

    @import url('https://fonts.googleapis.com/css2?family=Lora:wght@700&family=Montserrat:wght@500&display=swap');

    /* ðŸ“± Mobile First Adjustments */
    @media (max-width: 640px) {
      header h1 {
        font-size: 1.1rem !important;
      }

      main {
        padding: 1rem !important;
      }

      /* Cart item layout vertical */
      /* .cart-item {
        @apply flex flex-col items-start gap-3 !important;
      } */

      .cart-img {
        width: 64px !important;
        height: 64px !important;
      }

      .cart-title {
        font-size: 0.85rem !important;
      }

      .cart-price {
        font-size: 0.9rem !important;
      }

      .cart-qty button,
      .cart-qty span {
        font-size: 0.85rem !important;
      }

      #checkoutBtn {
        width: 100%;
        padding: 0.5rem !important;
        font-size: 1rem !important;
      }

      .total-box {
        text-align: center !important;
      }

      .shop {
        display: none !important;
      }
    }

    /* Very Small Phones */
    @media (max-width: 380px) {
      header h1 {
        font-size: 1rem !important;
      }
      header a {
        font-size: 0.8rem !important;
      }
      .cart-title {
        font-size: 0.75rem !important;
      }
    }
     /* Loader fade-out animation */
  #cart-loader.fade-out {
    opacity: 0;
    transition: opacity 0.4s ease;
    pointer-events: none;
  }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- PLACE AT TOP OF BODY -->
<div id="cartLoader" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <!-- <i class="fas fa-shopping-cart text-white text-5xl animate-pulse"></i> -->
  <svg xmlns="http://www.w3.org/2000/svg" class="fas fa-shopping-cart text-white w-12 h-12 animate-pulse"  viewBox="0 0 16 16"><path fill="currentColor" d="M0 
    2.5A.5.5 0 0 1 .5 2H2a.5.5 0 0 1 .485.379L2.89 4H14.5a.5.5 0 0 1 .485.621l-1.5 6A.5.5 0 0 1 13 11H4a.5.5 0 0 1-.485-.379L1.61 
    3H.5a.5.5 0 0 1-.5-.5M3.14 5l.5 2H5V5zM6 5v2h2V5zm3 0v2h2V5zm3 0v2h1.36l.5-2zm1.11 3H12v2h.61zM11 8H9v2h2zM8 8H6v2h2zM5 8H3.89l.5 2H5zm0 
    5a1 1 0 1 0 0 2a1 1 0 0 0 0-2m-2 1a2 2 0 1 1 4 0a2 2 0 0 1-4 0m9-1a1 1 0 1 0 0 2a1 1 0 0 0 0-2m-2 1a2 2 0 1 1 4 0a2 2 0 0 1-4 0"/></svg>
</div>

  <!-- Notification Container -->
<div id="notification-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>

  <header class="bg-gradient-to-r from-[#fbcfe8] to-[#f9a8d4] fixed top-0 w-full p-4 shadow-md flex justify-between items-center z-50">
    <button onclick="history.back()">
      <h1 class="text-xl font-bold">ðŸ›’ My Cart</h1>
    </button>
    <button onclick="history.back()">
      <div class="flex space-x-2">
        <a href="products.html"><i class="fas fa-shop mt-1"></i></a>
        <a href="products.html" class="shop text-pink-600 font-bold">Continue Shopping</a>
      </div>
    </button>
  </header>

  <main class="p-6 max-w-4xl mx-auto mt-16">
    <!-- Cart Skeletons (hidden by default) -->
    <div id="cartSkeleton" class="space-y-4">
      <div class="flex items-center justify-between bg-white p-4 rounded shadow animate-pulse cart-item">
        <div class="flex items-center gap-4">
          <div class="w-16 h-16 bg-gray-200 rounded cart-img"></div>
          <div>
            <div class="w-32 h-4 bg-gray-200 mb-2 rounded cart-title"></div>
            <div class="w-20 h-4 bg-gray-200 rounded cart-price"></div>
          </div>
        </div>
        <div class="flex items-center gap-2 cart-qty">
          <div class="w-6 h-4 bg-gray-200 rounded"></div>
          <div class="w-8 h-4 bg-gray-200 rounded"></div>
          <div class="w-6 h-4 bg-gray-200 rounded"></div>
        </div>
        <div class="text-right total-box">
          <div class="w-16 h-4 bg-gray-200 mb-2 rounded"></div>
          <div class="w-12 h-4 bg-gray-200 rounded"></div>
        </div>
      </div>
    </div>

    <div id="cartContainer" class="space-y-4"></div>

    <div class="text-right mt-6">
      <h2 class="text-xl font-semibold mb-2">Total: â‚¦<span id="totalPrice">0</span></h2>
        <button id="checkoutBtn" class="bg-pink-500 text-white px-6 py-2 rounded hover:bg-pink-600">Checkout</button>
    </div>
  </main>

<!-- Firebase Compat Scripts -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
(function(){
  // ----- Loader Overlay -----
  let loader = document.getElementById("cartLoader");
  if(!loader){
    loader = document.createElement("div");
    loader.id = "cartLoader";
    loader.style = `
      position: fixed; inset: 0; background: rgba(0,0,0,0.4);
      display: flex; align-items: center; justify-content: center;
      z-index: 9999; font-size: 50px; color: white; 
      transition: opacity 0.3s ease;
    `;
    loader.innerHTML = "ðŸ›’";
    document.body.appendChild(loader);
  }

  function hideLoader(){
    if(loader){
      loader.style.opacity = "0";
      setTimeout(()=> loader.remove(), 300);
    }
  }

  // --- Firebase App config ---
  const firebaseConfig = {
    apiKey: "AIzaSyDdTPmpaIPWSDWOmR-fXgvAb7hoxZUawcc",
    authDomain: "e-commerce-39c74.firebaseapp.com",
    projectId: "e-commerce-39c74",
    storageBucket: "e-commerce-39c74.firebasestorage.app",
    messagingSenderId: "863375033754",
    appId: "1:863375033754:web:7ba248c8dbb1566c83e623"
  };

  if (!window.firebase) {
    console.error("Firebase not loaded. Ensure firebase scripts are included on the page.");
    return;
  }

  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }

  const userAuth = firebase.auth();
  const userDb = firebase.firestore();

  // State
  let currentUser = null;
  let cartUnsub = null;

  // Elements
  const cartContainer = document.getElementById("cartContainer");
  const cartSkeleton  = document.getElementById("cartSkeleton");
  const totalSpan     = document.getElementById("totalPrice");
  const checkoutBtn   = document.getElementById("checkoutBtn");

  // Helpers
  function showElem(el){ if(!el) return; el.classList.remove('hidden'); }
  function hideElem(el){ if(!el) return; el.classList.add('hidden'); }
  function escapeHtml(text){ if(text==null) return ''; return String(text).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // ---------- Notifications ----------
  const activeNotifications = new Set();
  function showNotification(message, type="info", duration=3000){
    let container = document.getElementById("notification-container");
    if(!container){
      container = document.createElement("div");
      container.id = "notification-container";
      container.className = "fixed top-4 right-4 z-50 flex flex-col gap-2";
      document.body.appendChild(container);
    }

    if(activeNotifications.has(message)) return;
    activeNotifications.add(message);

    const notif = document.createElement("div");
    notif.className = `
      flex items-center justify-between gap-3 p-4 bg-white rounded-lg shadow-lg
      border border-gray-200 min-w-[250px] max-w-sm
      animate-slideIn
    `;
    const icon = document.createElement("span");
    if(type==="success") icon.innerHTML=`<i class="fas fa-check-circle text-green-500 text-xl"></i>`;
    else if(type==="error") icon.innerHTML=`<i class="fas fa-times-circle text-red-500 text-xl"></i>`;
    else if(type==="warning") icon.innerHTML=`<i class="fas fa-exclamation-triangle text-yellow-500 text-xl"></i>`;
    else icon.innerHTML=`<i class="fas fa-info-circle text-blue-500 text-xl"></i>`;
    const text = document.createElement("span");
    text.className="flex-1 text-gray-800 font-medium";
    text.textContent = message;
    const closeBtn = document.createElement("button");
    closeBtn.innerHTML = "&times;";
    closeBtn.className = "ml-4 text-gray-400 hover:text-gray-600 font-bold text-lg";
    closeBtn.onclick = () => removeNotification(notif, message);
    notif.appendChild(icon);
    notif.appendChild(text);
    notif.appendChild(closeBtn);
    container.appendChild(notif);

    setTimeout(()=> removeNotification(notif, message), duration);
  }
  function removeNotification(notif, message){
    if(!notif) return;
    notif.classList.remove("animate-slideIn");
    notif.classList.add("animate-slideOut");
    notif.addEventListener("animationend", ()=> notif.remove());
    activeNotifications.delete(message);
  }

  // Notification Styles
  const style = document.createElement("style");
  style.textContent = `
    #notification-container { display: flex; flex-direction: column; gap: 0.5rem; position: fixed; top: 1rem; right: 1rem; z-index: 9999; }
    @keyframes slideIn { from {opacity:0; transform: translateX(50px);} to {opacity:1; transform:translateX(0);} }
    .animate-slideIn { animation: slideIn 0.3s ease-out forwards; }
    @keyframes slideOut { from {opacity:1; transform:translateX(0);} to {opacity:0; transform:translateX(50px);} }
    .animate-slideOut { animation: slideOut 0.3s ease-in forwards; }
  `;
  document.head.appendChild(style);

  // ---------- CART LISTENER ----------
  function startCartListener(){
    stopCartListener();
    if (!currentUser) return;

    if(cartSkeleton) showElem(cartSkeleton);
    if(cartContainer) cartContainer.innerHTML = "";

    const itemsRef = userDb.collection("carts").doc(currentUser.uid).collection("items").orderBy("createdAt","asc");

    let firstLoad = true;

    cartUnsub = itemsRef.onSnapshot(snapshot => {
      const cartItems = snapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));
      if(cartSkeleton) hideElem(cartSkeleton);

      renderCart(cartItems);

      if(firstLoad){
        hideLoader();
        firstLoad = false;
      }
    }, error => {
      if(cartSkeleton) hideElem(cartSkeleton);
      console.error("Cart listener error:", error);
      showNotification("Failed to load cart", "error");
      renderCart([]);
      hideLoader();
    });
  }

  function stopCartListener(){
    if (cartUnsub) {
      try { cartUnsub(); } catch(e){ console.warn("Failed to unsubscribe cart listener", e); }
      cartUnsub = null;
    }
  }

  // ---------- CART RENDER ----------
  function renderCart(items = []){
    if(!cartContainer) return;
    cartContainer.innerHTML = "";
    let total = 0;

    if(!currentUser || items.length===0){
      cartContainer.innerHTML = `<p class="text-center text-gray-500">Your cart is empty.</p>`;
      if(totalSpan) totalSpan.textContent = "0";
      if(checkoutBtn){
        checkoutBtn.disabled = true;
        checkoutBtn.classList.add("opacity-50","cursor-not-allowed");
      }
      return;
    }

    items.forEach(it => {
      const quantity = it.quantity || 0;
      const price = it.price || 0;
      const originalPrice = it.originalPrice || null;
      const lineTotal = price * quantity;
      total += lineTotal;

      const div = document.createElement("div");
      div.className = "flex flex-col bg-white p-4 rounded shadow mb-3 cart-item";
      div.innerHTML = `
        <div class="flex items-start gap-4">
          <img src="${it.image || 'https://via.placeholder.com/64'}" class="w-24 h-24 object-cover rounded cart-img" alt="${escapeHtml(it.name)}">
          <div class="flex-1 space-y-1">
            <div class="font-medium text-gray-900">${escapeHtml(it.name)}</div>
            ${it.description ? `<div class="text-gray-500 text-sm">${escapeHtml(it.description)}</div>` : ''}
          </div>
        </div>
        <div class="mt-2 text-gray-700 font-semibold">Unit Price: â‚¦${price.toLocaleString()}</div>
        <div class="text-pink-500 font-bold">Total: â‚¦${lineTotal.toLocaleString()} (${quantity})</div>
        ${originalPrice ? `<div class="line-through text-gray-400 text-sm">â‚¦${originalPrice.toLocaleString()}</div>` : ''}
        <div class="mt-4 flex items-center justify-between">
          <button data-action="delete" data-id="${it.docId}" class="text-red-600 flex items-center gap-1">
            <i class="fas fa-trash-alt"></i> Delete
          </button>
          <div class="flex items-center gap-2">
            <button data-action="minus" data-id="${it.docId}" class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center">âˆ’</button>
            <span id="qty-${it.docId}" class="w-6 text-center">${quantity}</span>
            <button data-action="plus" data-id="${it.docId}" class="bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center">+</button>
          </div>
        </div>
      `;
      cartContainer.appendChild(div);

      const plusBtn = div.querySelector('button[data-action="plus"]');
      const minusBtn = div.querySelector('button[data-action="minus"]');
      const deleteBtn = div.querySelector('button[data-action="delete"]');
      const qtySpan = div.querySelector(`#qty-${it.docId}`);

      if(quantity<=1){ minusBtn.disabled=true; minusBtn.classList.add("opacity-50","cursor-not-allowed"); }

      plusBtn.onclick = async ()=>{
        if(plusBtn.disabled) return;
        plusBtn.disabled=true;
        await updateQtyWithSpinner(it.docId,1);
        setTimeout(()=>{ plusBtn.disabled=false },250);
        div.classList.add("fade-update");
        setTimeout(()=>div.classList.remove("fade-update"),300);
        showNotification("Item Added");
      };

      minusBtn.onclick = async ()=>{
        if(minusBtn.disabled) return;
        if(quantity<=1){ qtySpan.classList.add("shake"); setTimeout(()=>qtySpan.classList.remove("shake"),300); return; }
        minusBtn.disabled=true;
        await updateQtyWithSpinner(it.docId,-1);
        setTimeout(()=>{ minusBtn.disabled=false },250);
        div.classList.add("fade-update");
        setTimeout(()=>div.classList.remove("fade-update"),300);
        showNotification("Item Removed");
      };

      deleteBtn.onclick = async ()=>{
        deleteBtn.disabled=true;
        await Promise.resolve(removeWithSpinner(it.docId));
        deleteBtn.disabled=false;
        div.classList.add("fade-update");
        setTimeout(()=>div.remove(),300);
      };
    });

    if(totalSpan) totalSpan.textContent = total.toLocaleString();
    if(checkoutBtn){ checkoutBtn.disabled=false; checkoutBtn.classList.remove("opacity-50","cursor-not-allowed"); }
  }

  // ----- Spinners for qty actions -----
  function toggleSpinner(spinnerKey, show=true){
    const svg = document.querySelector(`[data-spinner="${spinnerKey}"]`);
    if(!svg) return;
    if(show) svg.classList.remove("hidden"); else svg.classList.add("hidden");
  }

  async function updateQtyWithSpinner(docId, delta, spinnerKey){
    if(!currentUser) return showNotification("Login required","error");
    toggleSpinner(spinnerKey,true);
    const itemRef = userDb.collection("carts").doc(currentUser.uid).collection("items").doc(docId);
    try{
      await userDb.runTransaction(async t=>{
        const doc = await t.get(itemRef);
        if(!doc.exists) throw new Error("Item missing");
        const newQty = (doc.data().quantity||0)+delta;
        if(newQty<=0) t.delete(itemRef); else t.update(itemRef,{quantity:newQty});
      });
    }catch(err){
      console.error("Quantity update failed:",err);
      showNotification("Quantity update failed","error");
    }finally{ toggleSpinner(spinnerKey,false); }
  }

  function removeWithSpinner(docId, spinnerKey){
    if(!currentUser) return showNotification("Login required","error");
    toggleSpinner(spinnerKey,true);
    userDb.collection("carts").doc(currentUser.uid).collection("items").doc(docId)
      .delete()
      .then(()=>showNotification("Item removed","success"))
      .catch(err=>{ console.error("Remove failed:",err); showNotification("Remove failed","error"); })
      .finally(()=>toggleSpinner(spinnerKey,false));
  }

  // Checkout
  if(checkoutBtn){
    checkoutBtn.addEventListener("click", e=>{
      e.preventDefault();
      if(!currentUser){ showNotification("Please log in to checkout","warning"); return; }
      window.location.href="checkout.html";
    });
  }

  // Auth listener
  userAuth.onAuthStateChanged(user=>{
    currentUser=user;
    if(user) startCartListener();
    else{
      stopCartListener();
      if(cartSkeleton) hideElem(cartSkeleton);
      renderCart([]);
      hideLoader(); // also hide loader if user is not logged in
    }
  });

  // Safety fallback
  setTimeout(()=>hideLoader(),5000);

  // Expose for debugging
  window._cart={startCartListener, stopCartListener};
})();
</script>
</body>
</html>