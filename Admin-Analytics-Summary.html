<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Analytics Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  .card { background:#fff; border-radius:12px; padding:18px; box-shadow:0 4px 20px rgba(0,0,0,0.05); }
  .skeleton { background:linear-gradient(90deg,#f0f0f0 25%, #e6e6e6 50%, #f0f0f0 75%); background-size:200% 100%; animation:skeleton 1.2s linear infinite; }
  @keyframes skeleton { from { background-position:200% 0 } to { background-position:-200% 0 } }
  .cursor-pointer { cursor:pointer; }

  /* Tiny screen tweaks */
  @media (max-width: 640px) {
    #totalSales, #totalOrders, #aov, #totalCustomers { font-size:1.5rem; }
    button { font-size:0.85rem; padding:0.5rem 1rem; }
    table thead { font-size:0.7rem; }
    table td { font-size:0.75rem; }
  }
</style>
</head>
<body class="bg-gray-50 text-gray-900">

<header class="bg-pink-600 text-white p-4 shadow fixed w-full z-50 top-0">
  <div class="max-w-7xl mx-auto flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 sm:gap-0">
    <div class="flex items-center space-x-2 w-full sm:w-auto">
      <button onclick="history.back()" class="text-white hover:text-gray-200">
        <i class="fas fa-arrow-left"></i>
      </button>
      <h1 class="text-xl font-semibold truncate">Admin Analytics</h1>
    </div>
    <div id="adminBadge" class="hidden text-sm bg-white text-pink-600 px-3 py-1 rounded mt-2 sm:mt-0">ADMIN</div>
  </div>
</header>

<main class="max-w-7xl mx-auto p-6 space-y-6 mt-20">

  <!-- Filters -->
  <section class="card">
    <div class="flex flex-col md:flex-row flex-wrap gap-3 md:items-center">
      <input id="searchQ" placeholder="Search product, customer, paymentRef..." class="border rounded p-2 flex-1 min-w-[120px]" />
      <input id="fromDate" type="date" class="border rounded p-2 flex-1 min-w-[120px]" />
      <input id="toDate" type="date" class="border rounded p-2 flex-1 min-w-[120px]" />
      <button id="applyFilters" class="bg-pink-600 text-white px-4 py-2 rounded flex-1 min-w-[100px]">Apply</button>
      <button id="clearFilters" class="bg-gray-200 px-4 py-2 rounded flex-1 min-w-[100px]">Clear</button>
      <button id="refreshBtn" class="ml-auto bg-blue-600 text-white px-3 py-2 rounded flex-1 min-w-[100px]">Refresh</button>
    </div>
  </section>

  <!-- Summary cards -->
  <section class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
    <div class="card text-center"><p class="text-sm text-gray-500">Total Sales (selected)</p><p id="totalSales" class="text-2xl font-bold text-pink-600">â‚¦0</p></div>
    <div class="card text-center"><p class="text-sm text-gray-500">Total Orders</p><p id="totalOrders" class="text-2xl font-bold text-pink-600">0</p></div>
    <div class="card text-center"><p class="text-sm text-gray-500">Average Order Value</p><p id="aov" class="text-2xl font-bold text-pink-600">â‚¦0</p></div>
    <div class="card text-center"><p class="text-sm text-gray-500">Total Customers</p><p id="totalCustomers" class="text-2xl font-bold text-pink-600">0</p></div>
  </section>

  <!-- Charts row -->
  <section class="grid grid-cols-1 lg:grid-cols-2 gap-4">
    <div class="card overflow-auto"><h3 class="font-semibold mb-2">Daily Sales (last 30 days)</h3><canvas id="dailySalesChart" height="120"></canvas></div>
    <div class="card overflow-auto"><h3 class="font-semibold mb-2">Monthly Revenue (this year)</h3><canvas id="monthlyChart" height="120"></canvas></div>
    <div class="card overflow-auto"><h3 class="font-semibold mb-2">Order Status</h3><canvas id="statusChart" height="120"></canvas></div>
    <div class="card overflow-auto"><h3 class="font-semibold mb-2">Payment Methods</h3><canvas id="paymentChart" height="120"></canvas></div>
  </section>

  <!-- Top Products & Customers -->
  <section class="grid grid-cols-1 lg:grid-cols-2 gap-4">
    <div class="card overflow-auto">
      <h3 class="font-semibold mb-2">Top 10 Products (by quantity)</h3>
      <table class="w-full text-left min-w-[300px]">
        <thead class="text-xs text-gray-600"><tr><th class="p-2">Product</th><th class="p-2">Qty Sold</th><th class="p-2">Revenue</th></tr></thead>
        <tbody id="topProductsBody"></tbody>
      </table>
      <div class="flex justify-end mt-2"><button id="loadMoreProducts" class="bg-pink-600 text-white px-3 py-1 rounded text-sm">Load More</button></div>
    </div>

    <div class="card overflow-auto">
      <h3 class="font-semibold mb-2">Top Customers (by spend)</h3>
      <table class="w-full text-left min-w-[300px]">
        <thead class="text-xs text-gray-600"><tr><th class="p-2">Customer</th><th class="p-2">Orders</th><th class="p-2">Spent</th></tr></thead>
        <tbody id="topCustomersBody"></tbody>
      </table>
      <div class="flex justify-end mt-2"><button id="loadMoreCustomers" class="bg-pink-600 text-white px-3 py-1 rounded text-sm">Load More</button></div>
    </div>
  </section>

  <!-- Real-time Orders Feed -->
  <section class="card">
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2">
      <h3 class="font-semibold">Real-time Orders Feed</h3>
      <div class="text-sm text-gray-600">Newest orders appear here</div>
    </div>
    <div id="liveFeed" class="mt-3 space-y-2 max-h-80 overflow-auto"></div>
  </section>

</main>

<!-- Modal -->
<div id="detailModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center flex justify-center z-50 p-4">
  <div class="bg-white rounded-lg max-w-lg w-full p-4">
    <div class="flex justify-between items-center mb-2">
      <h2 id="modalTitle" class="text-lg font-semibold">Details</h2>
      <button id="closeModal" class="text-gray-500 hover:text-gray-700">&times;</button>
    </div>
    <div id="modalContent" class="text-sm space-y-2"></div>
  </div>
</div>

<div id="dashboard-loader" class="fixed inset-0 flex items-center justify-center bg-black/40 z-50 hidden">
  <i class="fas fa-spinner fa-spin text-white text-5xl"></i>
</div>

  <script>
  // ===== Firebase Config =====
  const firebaseConfig = {
    apiKey: "AIzaSyDdTPmpaIPWSDWOmR-fXgvAb7hoxZUawcc",
    authDomain: "e-commerce-39c74.firebaseapp.com",
    projectId: "e-commerce-39c74",
    storageBucket: "e-commerce-39c74.firebasestorage.app",
    messagingSenderId: "863375033754",
    appId: "1:863375033754:web:7ba248c8dbb1566c83e623"
  };
  
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ===== State =====
  let dailyChart, monthlyChart, statusChart, paymentChart, ordersSnapshotUnsub=null;
  let productsDisplayLimit=5, customersDisplayLimit=5, lastProductsArr=[], lastCustomersArr=[];

  let isAdmin = false;

firebase.auth().onAuthStateChanged(async user => {
  if (user) {
    const adminDoc = await db.collection('admins').doc(user.uid).get();
    isAdmin = adminDoc.exists;
    window.isAdmin = isAdmin; // optional if you want global access

    if (isAdmin) {
      loadAllAnalytics();   // only load analytics if admin
      startRealtimeFeed();
    } else {
      alert('You do not have permission to view this page.');
      // redirect or hide content
    }
  }
});


  // ===== Refs =====
  const totalSalesEl=document.getElementById('totalSales');
  const totalOrdersEl=document.getElementById('totalOrders');
  const aovEl=document.getElementById('aov');
  const totalCustomersEl=document.getElementById('totalCustomers');
  const topProductsBody=document.getElementById('topProductsBody');
  const topCustomersBody=document.getElementById('topCustomersBody');
  const liveFeed=document.getElementById('liveFeed');
  const searchQ=document.getElementById('searchQ');
  const fromDate=document.getElementById('fromDate');
  const toDate=document.getElementById('toDate');
  const applyFilters=document.getElementById('applyFilters');
  const clearFilters=document.getElementById('clearFilters');
  const refreshBtn=document.getElementById('refreshBtn');
  const modal=document.getElementById('detailModal');
  const modalTitle=document.getElementById('modalTitle');
  const modalContent=document.getElementById('modalContent');
  let loader = document.getElementById("dashboard-loader");

  // ===== Global Loader =====
function showLoader() {
  closeModal();
  loader.classList.remove("hidden");
  document.body.style.overflow = "hidden";
  // document.body.style.pointerEvents = "none";
}

function hideLoader() {
  loader.classList.add("hidden");
  document.body.style.overflow = "";
  // document.body.style.pointerEvents = "";
}

function openModal() {
  modal.classList.remove("hidden");
  document.body.style.overflow = "hidden"; // disable background scroll
}

function closeModal() {
  modal.classList.add("hidden");
  document.body.style.overflow = ""; // restore scroll
}

  // ===== Button Event Listeners =====
  applyFilters.addEventListener('click', ()=>{
    loadAllAnalytics();
    startRealtimeFeed();
  });

  clearFilters.addEventListener('click', ()=>{
    searchQ.value = '';
    fromDate.value = '';
    toDate.value = '';
    loadAllAnalytics();
    startRealtimeFeed();
  });

  refreshBtn.addEventListener('click', ()=>{
    loadAllAnalytics();
    startRealtimeFeed();
  });

  document.getElementById('loadMoreProducts').addEventListener('click', ()=>{
    productsDisplayLimit += 5;
    displayProducts();
  });

  document.getElementById('loadMoreCustomers').addEventListener('click', ()=>{
    customersDisplayLimit +=5;
    displayCustomers();
  });

  // document.getElementById('closeModal').addEventListener('click', ()=>modal.classList.add('hidden'));
  document.getElementById('closeModal')
  .addEventListener('click', closeModal);

  modal.addEventListener("click", e => {
  // Only close if clicking the overlay, not the modal box
  if (e.target === modal) {
    closeModal();
  }
});

  // ===== Initialize Charts =====
  function initCharts(){
    const ctxDaily=document.getElementById('dailySalesChart').getContext('2d');
    dailyChart=new Chart(ctxDaily,{
      type:'line',
      data:{labels:[],datasets:[{label:'Sales',data:[],fill:true,backgroundColor:'rgba(219,39,119,0.12)',borderColor:'#db2777'}]},
      options:{responsive:true,scales:{x:{grid:{display:false}},y:{ticks:{callback:v=>'â‚¦'+v}}}}
    });

    const ctxMonthly=document.getElementById('monthlyChart').getContext('2d');
    monthlyChart=new Chart(ctxMonthly,{
      type:'bar',
      data:{labels:[],datasets:[{label:'Monthly Revenue',data:[],backgroundColor:'#f472b6'}]},
      options:{responsive:true,y:{ticks:{callback:v=>'â‚¦'+v}}}
    });

    const ctxStatus=document.getElementById('statusChart').getContext('2d');
    statusChart=new Chart(ctxStatus,{
      type:'doughnut',
      data:{labels:['Completed','Pending'],datasets:[{data:[0,0],backgroundColor:['#10b981','#f59e0b']}]},
      options:{responsive:true}
    });

    const ctxPayment=document.getElementById('paymentChart').getContext('2d');
    paymentChart=new Chart(ctxPayment,{
      type:'pie',
      data:{labels:[],datasets:[{data:[],backgroundColor:[]}]},
      options:{responsive:true}
    });
  }

  initCharts();
  loadAllAnalytics();
  startRealtimeFeed();

  // ===== Load Analytics =====
  async function loadAllAnalytics(){
    showLoader(); // ðŸ‘ˆ START loader

    totalSalesEl.textContent='Loading...';
    totalOrdersEl.textContent='â€¦';
    aovEl.textContent='â€¦';
    totalCustomersEl.textContent='â€¦';
    topProductsBody.innerHTML=`<tr><td colspan="3" class="p-3 skeleton"></td></tr>`;
    topCustomersBody.innerHTML=`<tr><td colspan="3" class="p-3 skeleton"></td></tr>`;
    liveFeed.innerHTML=`<div class="p-3 skeleton h-20"></div>`;

    let q=db.collection('orders').orderBy('timestamp','desc');

    const from=fromDate.value?firebase.firestore.Timestamp.fromDate(new Date(fromDate.value+'T00:00:00')):null;
    const to=toDate.value?firebase.firestore.Timestamp.fromDate(new Date(toDate.value+'T23:59:59')):null;
    if(from) q=q.where('timestamp','>=',from);
    if(to) q=q.where('timestamp','<=',to);

    try{
      const snap=await q.limit(5000).get();
      const orders=snap.docs.map(d=>({id:d.id,...d.data()}));
      const term=(searchQ.value||'').trim().toLowerCase();
      const filtered=term?orders.filter(o=>{
        if((o.name||'').toLowerCase().includes(term)) return true;
        if((o.email||'').toLowerCase().includes(term)) return true;
        if((o.paymentRef||'').toLowerCase().includes(term)) return true;
        if(Array.isArray(o.items)&&o.items.some(it=>(it.name||'').toLowerCase().includes(term))) return true;
        return false;
      }):orders;

      computeSummaries(filtered);
      computeDailyChart(filtered);
      computeMonthlyChart(filtered);
      computeStatusChart(filtered);
      computePaymentChart(filtered);
      renderTopProducts(filtered);
      renderTopCustomers(filtered);
    }catch(err){
      console.error(err);
      totalSalesEl.textContent='Error';
      totalOrdersEl.textContent='Error';
      aovEl.textContent='Error';
      totalCustomersEl.textContent='Error';
    }finally {
    hideLoader(); // ðŸ‘ˆ STOP loader (always)
  }
  }

  // ===== Compute Summaries =====
  function computeSummaries(orders){
    const totalOrders=orders.length;
    const totalSales=orders.reduce((s,o)=>s+Number(o.total||0),0);
    const uniqueCustomers=new Set(orders.map(o=>o.userId||o.email||'')).size;
    const aov=totalOrders?totalSales/totalOrders:0;
    totalSalesEl.textContent='â‚¦'+totalSales.toLocaleString();
    totalOrdersEl.textContent=totalOrders.toLocaleString();
    aovEl.textContent='â‚¦'+Math.round(aov).toLocaleString();
    totalCustomersEl.textContent=uniqueCustomers.toLocaleString();
  }

  function computeDailyChart(orders){
    const days=30,map={};
    for(let i=days-1;i>=0;i--){
      const d=new Date(); d.setDate(d.getDate()-i); d.setHours(0,0,0,0);
      map[d.toISOString().slice(0,10)]=0;
    }
    orders.forEach(o=>{
      if(!o.timestamp) return;
      const d=o.timestamp.toDate?o.timestamp.toDate():new Date(o.timestamp);
      const key=d.toISOString().slice(0,10);
      if(key in map) map[key]+=Number(o.total||0);
    });
    dailyChart.data.labels=Object.keys(map);
    dailyChart.data.datasets[0].data=Object.values(map);
    dailyChart.update();
  }

  function computeMonthlyChart(orders){
    const now=new Date(), year=now.getFullYear(), months=Array.from({length:12},(_,i)=>new Date(year,i,1));
    const map=months.map(_=>0);
    orders.forEach(o=>{
      if(!o.timestamp) return;
      const d=o.timestamp.toDate?o.timestamp.toDate():new Date(o.timestamp);
      if(d.getFullYear()!==year) return;
      map[d.getMonth()]+=Number(o.total||0);
    });
    monthlyChart.data.labels=months.map(m=>m.toLocaleString(undefined,{month:'short'}));
    monthlyChart.data.datasets[0].data=map;
    monthlyChart.update();
  }

  function computeStatusChart(orders){
    let completed=0,pending=0;
    orders.forEach(o=>o.fulfilled?completed++:pending++);
    statusChart.data.datasets[0].data=[completed,pending];
    statusChart.update();
  }

  function computePaymentChart(orders){
    const counts={};
    orders.forEach(o=>{
      const pm=o.paymentMethod||'Unknown';
      counts[pm]=(counts[pm]||0)+1;
    });
    const labels=Object.keys(counts);
    const data=labels.map(l=>counts[l]);
    const colors=labels.map((_,i)=>`hsl(${(i*73)%360} 70% 60%)`);
    paymentChart.data.labels=labels;
    paymentChart.data.datasets[0].data=data;
    paymentChart.data.datasets[0].backgroundColor=colors;
    paymentChart.update();
  }

  // ===== Top Products/Customers =====
  function renderTopProducts(orders){
    const map={};
    orders.forEach(o=>(o.items||[]).forEach(it=>{
      const name=it.name||'Untitled';
      if(!map[name]) map[name]={qty:0,revenue:0,lastOrder:o.timestamp?o.timestamp.toDate():new Date()};
      map[name].qty+=Number(it.quantity||0);
      map[name].revenue+=Number(it.quantity||0)*Number(it.price||0);
      if(o.timestamp && o.timestamp.toDate) map[name].lastOrder=o.timestamp.toDate();
    }));
    lastProductsArr=Object.entries(map).map(([name,v])=>({name,qty:v.qty,revenue:v.revenue,lastOrder:v.lastOrder})).sort((a,b)=>b.qty-a.qty);
    displayProducts();
  }

  function displayProducts(){
    const top=lastProductsArr.slice(0,productsDisplayLimit);
    topProductsBody.innerHTML=top.length?top.map((t,i)=>`
      <tr class="cursor-pointer hover:bg-gray-100" data-index="${i}">
        <td class="p-2">${escapeHtml(t.name)}</td>
        <td class="p-2">${t.qty.toLocaleString()}</td>
        <td class="p-2">â‚¦${Math.round(t.revenue).toLocaleString()}</td>
      </tr>`).join(''):`<tr><td colspan="3" class="p-3 text-gray-500">No product data</td></tr>`;
  }

  function renderTopCustomers(orders){
    const map={};
    orders.forEach(o=>{
      const key=o.userId||o.email||o.name||('guest-'+(o.paymentRef||''));
      if(!map[key]) map[key]={name:o.name||o.email||'Customer',email:o.email||'',orders:0,spent:0,lastOrder:o.timestamp?o.timestamp.toDate():new Date()};
      map[key].orders++; map[key].spent+=Number(o.total||0); if(o.timestamp && o.timestamp.toDate) map[key].lastOrder=o.timestamp.toDate();
    });
    lastCustomersArr=Object.values(map).sort((a,b)=>b.spent-a.spent);
    displayCustomers();
  }

  function displayCustomers(){
    const top=lastCustomersArr.slice(0,customersDisplayLimit);
    topCustomersBody.innerHTML=top.length?top.map((c,i)=>`
      <tr class="cursor-pointer hover:bg-gray-100" data-index="${i}">
        <td class="p-2">${escapeHtml(c.name)}</td>
        <td class="p-2">${c.orders}</td>
        <td class="p-2">â‚¦${Math.round(c.spent).toLocaleString()}</td>
      </tr>`).join(''):`<tr><td colspan="3" class="p-3 text-gray-500">No customer data</td></tr>`;
  }

  // ===== Modals =====
  topProductsBody.addEventListener('click', e=>{
    const tr=e.target.closest('tr'); if(!tr) return;
    const t=lastProductsArr[Number(tr.dataset.index)]; if(!t) return;
    modalTitle.textContent=`Product: ${t.name}`;
    modalContent.innerHTML=`<p><strong>Quantity Sold:</strong> ${t.qty}</p>
      <p><strong>Total Revenue:</strong> â‚¦${Math.round(t.revenue).toLocaleString()}</p>
      <p><strong>Last Ordered:</strong> ${t.lastOrder.toLocaleString()}</p>`;
    // modal.classList.remove('hidden');
    openModal();
  });

  topCustomersBody.addEventListener('click', e=>{
    const tr=e.target.closest('tr'); if(!tr) return;
    const c=lastCustomersArr[Number(tr.dataset.index)]; if(!c) return;
    modalTitle.textContent=`Customer: ${c.name}`;
    modalContent.innerHTML=`<p><strong>Email:</strong> ${escapeHtml(c.email)}</p>
      <p><strong>Total Orders:</strong> ${c.orders}</p>
      <p><strong>Total Spent:</strong> â‚¦${Math.round(c.spent).toLocaleString()}</p>
      <p><strong>Last Order:</strong> ${c.lastOrder.toLocaleString()}</p>`;
    // modal.classList.remove('hidden');
    openModal();
  });

  // ===== Real-time Feed =====
  function startRealtimeFeed(){
    if(ordersSnapshotUnsub) ordersSnapshotUnsub();
    let q=db.collection('orders').orderBy('timestamp','desc').limit(15);

    // apply date and search filters
    const from=fromDate.value?firebase.firestore.Timestamp.fromDate(new Date(fromDate.value+'T00:00:00')):null;
    const to=toDate.value?firebase.firestore.Timestamp.fromDate(new Date(toDate.value+'T23:59:59')):null;

    if(from) q=q.where('timestamp','>=',from);
    if(to) q=q.where('timestamp','<=',to);

    const term=(searchQ.value||'').trim().toLowerCase();

    ordersSnapshotUnsub=q.onSnapshot(snap=>{
      liveFeed.innerHTML='';
      snap.docs.forEach(d=>{
        const o=d.data();
        if(term){
          let match=false;
          if((o.name||'').toLowerCase().includes(term)) match=true;
          if((o.email||'').toLowerCase().includes(term)) match=true;
          if((o.paymentRef||'').toLowerCase().includes(term)) match=true;
          if(Array.isArray(o.items)&&o.items.some(it=>(it.name||'').toLowerCase().includes(term))) match=true;
          if(!match) return;
        }
        const time=o.timestamp?o.timestamp.toDate().toLocaleTimeString(): '';
        const div=document.createElement('div'); 
        div.className='p-2 border-b cursor-pointer hover:bg-gray-100';
        div.textContent=`${o.name||o.email||'Guest'} - â‚¦${Math.round(o.total||0).toLocaleString()} - ${time}`;
        liveFeed.appendChild(div);
      });
    });
  }

  // ===== Helpers =====
  function escapeHtml(text) {
  return (text||'').toString().replace(/[&<>"']/g, m => ({
    '&':'&amp;',
    '<':'&lt;',
    '>':'&gt;',
    '"':'&quot;',
    "'":'&#39;'
  }[m]));
}
</script>
</body>
</html>
