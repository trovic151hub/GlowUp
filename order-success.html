<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Success</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">

<style>
  * {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
  }

  @import url('https://fonts.googleapis.com/css2?family=Lora:wght@700&family=Montserrat:wght@500&display=swap');

  /* MOBILE */
  @media (max-width: 640px) {
    .card-box { padding: 1.5rem !important; }
    h1 { font-size: 1.5rem; }
    #successMessage { font-size: 1rem; }
    a { width: 100%; padding: 0.75rem; }
  }

  /* VERY SMALL SCREEN */
  @media (max-width: 380px) {
    h1 { font-size: 1.3rem; }
    #successMessage { font-size: 0.95rem; }
    a { font-size: 0.95rem; padding: 0.6rem; }
  }

  /* Emoji Pulse */
  @keyframes pulse { 
    0%,100% { transform: scale(1); }
    50% { transform: scale(1.2); }
  }

  h1::before {
    content: 'üéâ ';
    display: inline-block;
    animation: pulse 1.5s infinite;
  }

  /* Fade-in Animation */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .animate-fadeIn { animation: fadeIn 0.5s ease-out; }
</style>
</head>

<body class="bg-gradient-to-br from-pink-100 via-pink-200 to-pink-300 text-gray-900">

  <main class="min-h-screen flex flex-col justify-center items-center p-6">

    <div class="card-box bg-white/90 backdrop-blur-lg p-8 rounded-2xl shadow-xl max-w-md w-full text-center animate-fadeIn border border-pink-200">

      <!-- Success Icon -->
      <div class="flex justify-center mb-4">
        <div class="w-20 h-20 bg-pink-100 rounded-full flex items-center justify-center shadow-inner">
          <i class="fas fa-check text-pink-600 text-4xl"></i>
        </div>
      </div>

      <h1 class="text-3xl font-bold text-pink-600 mb-2">Order Successful!</h1>

      <p id="successMessage" class="mb-6 text-gray-700 text-base">
        Thank you for your purchase. Your order has been confirmed.
      </p>

      <a href="customer-dashboard.html" 
         class="block bg-pink-600 text-white px-4 py-2 rounded-lg mb-3 hover:bg-pink-700 transition">
        View Orders
      </a>

      <a href="index.html" 
         class="block text-pink-700 font-medium">
         Back to Home
      </a>

    </div>

  </main>


<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
  // ===== Firebase Config =====
  const firebaseConfig = {
    apiKey: "AIzaSyDdTPmpaIPWSDWOmR-fXgvAb7hoxZUawcc",
    authDomain: "e-commerce-39c74.firebaseapp.com",
    projectId: "e-commerce-39c74",
    storageBucket: "e-commerce-39c74.firebasestorage.app",
    messagingSenderId: "863375033754",
    appId: "1:863375033754:web:7ba248c8dbb1566c83e623"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const msg = document.getElementById("successMessage");

  // ===== Safe Timestamp Converter =====
  function safeToDate(ts) {
    if (!ts) return null;
    if (ts.toDate) return ts.toDate();
    if (ts.seconds) return new Date(ts.seconds * 1000);
    return null;
  }

  // ===== Fetch Latest Order =====
auth.onAuthStateChanged(async (user) => {
  if (!user) {
    msg.textContent = "Your order was processed.";
    return;
  }

  try {
    const snapshot = await db
      .collection("orders")
      .where("userId", "==", user.uid)
      .orderBy("createdAt", "desc")
      .limit(1)
      .get();

    if (snapshot.empty) {
      msg.textContent = "Your order was processed.";
      return;
    }

    const latestOrderData = snapshot.docs[0].data();

    // ===== Safe values =====
    const name = latestOrderData.name || "Customer";
    const subtotal = latestOrderData.subtotal ?? 0;
    const deliveryFee = latestOrderData.deliveryFee ?? 0;
    const delivery = latestOrderData.delivery || {};
    const isInternational = !!delivery.isInternational;

    const total =
      isInternational
        ? null
        : latestOrderData.total ?? subtotal + deliveryFee;

    const paymentMethod = isInternational ? "WhatsApp" : "Paystack";
    const status = latestOrderData.status || (isInternational ? "pending_confirmation" : "paid");

    // ===== Build message =====
    setTimeout(() => {
      msg.innerHTML = `
        Thank you, <strong>${name}</strong>!<br>

        ${
          isInternational
            ? `
              <div class="mt-2 text-yellow-700 font-semibold">
                üåç International order ‚Äì delivery cost will be confirmed via WhatsApp.
              </div>
            `
            : `
              Your order total is
              <strong>‚Ç¶${total.toLocaleString()}</strong>.
            `
        }

        <br>
        Payment Method: <strong>${paymentMethod}</strong>

        ${
          isInternational
            ? `
              <div class="mt-4 p-3 bg-yellow-50 border border-yellow-300 rounded">
                <div><strong>Country:</strong> ${delivery.country || "‚Äî"}</div>
                <div><strong>Address:</strong> ${delivery.address || "‚Äî"}</div>
                <div class="text-sm text-gray-700 mt-1">
                  Status: Pending confirmation
                </div>
              </div>
            `
            : ""
        }
      `;
    }, 1000);

    // ===== Clear cart items =====
    const cartRef = db.collection("carts").doc(user.uid).collection("items");
    const cartSnapshot = await cartRef.get();
    const batch = db.batch();
    cartSnapshot.forEach(doc => batch.delete(doc.ref));
    await batch.commit();

  } catch (err) {
    console.error("Error fetching latest order:", err);
    msg.textContent = "Your order was processed.";
  }
});

//   // ===== Fetch Latest Order =====
//   auth.onAuthStateChanged(async (user) => {
//   if (!user) {
//     msg.textContent = "Your order was processed.";
//     return;
//   }

//   try {
//     const snapshot = await db
//       .collection("orders")
//       .where("userId", "==", user.uid)
//       .orderBy("createdAt", "desc")
//       .limit(1)
//       .get();

//     if (snapshot.empty) {
//       msg.textContent = "Your order was processed.";
//       return;
//     }

//     const latestOrderData = snapshot.docs[0].data();

//     // Safe values
//     const name = latestOrderData.name || "Customer";
//     const subtotal = latestOrderData.subtotal ?? 0;
//     const deliveryFee = latestOrderData.deliveryFee ?? 0;
//     const total = latestOrderData.total ?? subtotal + deliveryFee;
//     const paymentMethod = latestOrderData.paymentMethod ?? (latestOrderData.delivery?.isInternational ? "WhatsApp" : "Unknown");
//     const delivery = latestOrderData.delivery || {};

//     // // Build delivery info HTML
//     // let deliveryInfoHtml = "";
//     // if (delivery.isInternational) {
//     //   deliveryInfoHtml = `
//     //     <div class="mt-4 p-3 bg-yellow-50 border border-yellow-300 rounded shadow-sm">
//     //       <div class="font-semibold mb-1 text-yellow-800">üåç International Delivery</div>
//     //       <div>Country: ${delivery.country || "‚Äî"}</div>
//     //       <div>Address: ${delivery.address || "‚Äî"}</div>
//     //       <div>Delivery Type: ${delivery.type || "‚Äî"}</div>
//     //     </div>
//     //   `;
//     // } else {
//     //   deliveryInfoHtml = `
//     //     <div class="mt-4 p-3 bg-gray-50 rounded shadow-sm">
//     //       <div class="font-semibold mb-1">Delivery Info</div>
//     //       <div>State: ${delivery.state || "‚Äî"}</div>
//     //       <div>LGA: ${delivery.lga || "‚Äî"}</div>
//     //       <div>Address: ${delivery.address || "‚Äî"}</div>
//     //       <div>Type: ${delivery.type || "‚Äî"}</div>
//     //       <div>Fee: ‚Ç¶${deliveryFee.toLocaleString()}</div>
//     //     </div>
//     //   `;
//     // }

//     // Build success message
//     setTimeout(() => {
//       msg.innerHTML = `
//         Thank you, <strong>${name}</strong>!<br>
//         Your order total is <strong>‚Ç¶${total.toLocaleString()}</strong>.<br>
//         Payment Method: <strong>${paymentMethod}</strong>
        
//       `;
//     }, 1000);

//     // Optional: Clear cart items
//     const cartRef = db.collection("carts").doc(user.uid).collection("items");
//     const cartSnapshot = await cartRef.get();
//     const batch = db.batch();
//     cartSnapshot.forEach(doc => batch.delete(doc.ref));
//     await batch.commit();

//   } catch (err) {
//     console.error("Error fetching latest order:", err);
//     msg.textContent = "Your order was processed.";
//   }
// });
  // auth.onAuthStateChanged(async user => {
  //   if (!user) {
  //     msg.textContent = "Your order was processed.";
  //     return;
  //   }

  //   try {
  //     const snapshot = await db
  //       .collection("orders")
  //       .where("userId", "==", user.uid)
  //       .get();

  //     if (snapshot.empty) {
  //       msg.textContent = "Your order was processed.";
  //       return;
  //     }

  //     // Find most recent order safely
  //     let latestOrder = null;
  //     let latestDate = null;

  //     snapshot.forEach(doc => {
  //       const data = doc.data();
  //       const orderDate =
  //         safeToDate(data.createdAt) ||
  //         safeToDate(data.timestamp);

  //       if (!orderDate) return;

  //       if (!latestDate || orderDate > latestDate) {
  //         latestDate = orderDate;
  //         latestOrder = data;
  //       }
  //     });

  //     if (latestOrder) {
  //       setTimeout(() => {
  //         msg.innerHTML = `
  //           Thank you, <strong>${latestOrder.name}</strong>!<br>
  //           Your order total is <strong>‚Ç¶${latestOrder.total.toLocaleString()}</strong>.<br>
  //           Payment Method: <strong>${latestOrder.paymentMethod}</strong>
  //         `;
  //       }, 3000);
  //     } else {
  //       msg.textContent = "Your order was processed.";
  //     }

      // // Clear cart items
      // const cartRef = db.collection("carts").doc(user.uid).collection("items");
      // const cartSnapshot = await cartRef.get();
      // const batch = db.batch();
      // cartSnapshot.forEach(doc => batch.delete(doc.ref));
      // await batch.commit();

  //   } catch (err) {
  //     console.error("Error fetching latest order:", err);
  //     msg.textContent = "Your order was processed.";
  //   }
  // });
</script>
</body>
</html>