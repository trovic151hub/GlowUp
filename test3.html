<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Order History â€” Advanced</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
  <!-- EmailJS SDK -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    emailjs.init("cRuLIat7A3PEivQCu"); //EmailJS public key
  </script>
  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    @keyframes slide-in { 0%{transform:translateY(-20px);opacity:0}100%{transform:none;opacity:1} }
    .animate-slide-in { animation: slide-in .22s ease-out; }
    .timeline-step { width: 10px; height: 10px; border-radius: 999px; display:inline-block; margin-right:8px; }

    /* Optional tiny tweaks for very small screens */
    @media (max-width: 640px) {
      #ordersSummary { font-size: 0.8rem; }
      #loadMoreBtn { padding: 0.5rem 1rem; font-size: 0.85rem; }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">

<header class="bg-pink-600 text-white p-4 fixed w-full z-50 top-0">
  <div class="max-w-6xl mx-auto flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 sm:gap-0">
    <div class="flex items-center space-x-2">
      <button onclick="history.back()" class="text-white hover:text-gray-200">
        <i class="fas fa-arrow-left"></i>
      </button>
      <h1 class="text-lg font-bold truncate">Order History â€” Advanced</h1>
    </div>
    <div id="adminBadge" class="hidden bg-white text-pink-600 px-2 py-1 rounded text-sm mt-2 sm:mt-0">ADMIN</div>
  </div>
</header>

<main class="max-w-6xl mx-auto p-6 mt-20">

  <!-- FILTERS / SEARCH -->
  <section class="bg-white p-4 rounded shadow mb-6">
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3">
      <input id="qText" placeholder="Search product / name / paymentRef" class="border p-2 rounded w-full" />
      <select id="filterStatus" class="border p-2 rounded w-full">
        <option value="all">All status</option>
        <option value="pending">Pending</option>
        <option value="completed">Completed</option>
      </select>
      <select id="filterShipment" class="border p-2 rounded w-full">
        <option value="all">All shipment</option>
        <option value="processing">Processing</option>
        <option value="shipped">Shipped</option>
        <option value="delivered">Delivered</option>
      </select>
      <select id="filterPayment" class="border p-2 rounded w-full">
        <option value="all">All payment</option>
        <option value="paystack">Paystack</option>
        <option value="flutterwave">Flutterwave</option>
        <option value="whatsapp">WhatsApp</option>
      </select>
    </div>

    <div class="flex flex-col sm:flex-row flex-wrap gap-3 mt-3">
      <input id="dateFrom" type="date" class="border p-2 rounded flex-1 min-w-[120px]" />
      <input id="dateTo" type="date" class="border p-2 rounded flex-1 min-w-[120px]" />
      <button id="applyFilters" class="bg-pink-600 text-white px-4 py-2 rounded flex-1 min-w-[120px]">Apply</button>
      <button id="clearFilters" class="bg-gray-200 px-4 py-2 rounded flex-1 min-w-[120px]">Clear</button>
      <div class="ml-auto flex gap-2 flex-wrap">
        <button id="refreshBtn" class="bg-blue-600 text-white px-3 py-2 rounded">Refresh</button>
      </div>
    </div>
  </section>

  <!-- <div id="ordersSummary" class="mb-4 p-2 bg-gray-100 rounded text-sm text-gray-700">
    Loading summary...
  </div> -->

  <!-- ORDERS TABLE -->
  <section class="bg-white p-4 rounded shadow">
    <div class="overflow-x-auto">
      <table class="w-full text-left min-w-[600px]">
        <thead class="bg-pink-100">
          <tr>
            <th class="p-2">When</th>
            <th class="p-2">Customer</th>
            <th class="p-2">Total</th>
            <th class="p-2">Payment</th>
            <th class="p-2">Shipment</th>
            <th class="p-2">Status</th>
            <th class="p-2">Actions</th>
          </tr>
        </thead>
        <tbody id="ordersTbody" class="w-full border-collapse"></tbody>
      </table>
    </div>
    <div class="flex justify-center mt-4">
      <button id="loadMoreBtn" class="bg-pink-500 text-white px-4 py-2 rounded">Load more</button>
    </div>
  </section>
</main>

<!-- DETAIL MODAL -->
<div id="detailModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
  <div class="bg-white w-full max-w-lg sm:max-w-lg md:max-w-2xl p-6 rounded shadow-lg animate-slide-in max-h-[90vh] overflow-auto">
    <div class="flex justify-between items-start gap-4">
      <h2 class="text-2xl font-semibold text-pink-600">Order Details</h2>
      <div>
        <button id="modalClose" class="text-gray-600 hover:text-gray-800 text-xl">&times;</button>
      </div>
    </div>
    <div id="internationalControls" class="mt-3"></div>
    <div id="detailContent" class="mt-4 space-y-3 text-sm text-gray-800"></div>
    <div class="mt-4 flex gap-2 flex-wrap">
      <button id="downloadPdfBtn" class="bg-pink-600 text-white px-4 py-2 rounded flex-1 min-w-[120px]">Download Receipt</button>
      <button id="emailReceiptBtn" class="bg-blue-600 text-white px-4 py-2 rounded opacity-50 cursor-not-allowed flex-1 min-w-[120px]" disabled>Email Receipt</button>
      <div id="modalStatusControls" class="ml-auto flex gap-2 flex-wrap"></div>
    </div>
  </div>
</div>

<!-- LOADER -->
<div id="dashboard-loader" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50">
  <i class="fas fa-spinner fa-spin text-white text-5xl"></i>
</div>

<script>
  // ===== Firebase Config =====
  const firebaseConfig = {
    apiKey: "AIzaSyDdTPmpaIPWSDWOmR-fXgvAb7hoxZUawcc",
    authDomain: "e-commerce-39c74.firebaseapp.com",
    projectId: "e-commerce-39c74",
    storageBucket: "e-commerce-39c74.firebasestorage.app",
    messagingSenderId: "863375033754",
    appId: "1:863375033754:web:7ba248c8dbb1566c83e623"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let PAGE_SIZE = 6, lastDoc = null, loadingMore = false, activeFilters = {}, currentOpenOrder = null;
  window.isAdmin = false; // default

  // ===== Check Admin from "admins" collection =====
firebase.auth().onAuthStateChanged(async (user) => {
  showLoader();
  if (user) {
    try {
      const adminDoc = await db.collection("admins").doc(user.uid).get();
      window.isAdmin = adminDoc.exists;
    } catch (err) {
      console.error("Failed to check admin status:", err);
      window.isAdmin = false;
    }
  } else {
    window.isAdmin = false;
  }
  clearAndLoad(); // your existing function
  hideLoader();
});

  const ordersTbody = document.getElementById('ordersTbody');
  const loadMoreBtn = document.getElementById('loadMoreBtn');
  const qText = document.getElementById('qText');
  const filterStatus = document.getElementById('filterStatus');
  const filterShipment = document.getElementById('filterShipment');
  const filterPayment = document.getElementById('filterPayment');
  const dateFrom = document.getElementById('dateFrom');
  const dateTo = document.getElementById('dateTo');
  const detailModal = document.getElementById('detailModal');
  const detailContent = document.getElementById('detailContent');
  const modalClose = document.getElementById('modalClose');
  const ordersSummary = document.getElementById('ordersSummary');
  const modalStatusControls = document.getElementById('modalStatusControls');
  const loader = document.getElementById("dashboard-loader");

  // ===== ALERT MODAL =====
  const alertModal = document.createElement('div');
  alertModal.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50';
  alertModal.innerHTML = `
    <div class="bg-white p-6 rounded shadow-lg w-80 text-center">
      <div id="alertMessage" class="mb-4"></div>
      <button id="alertOkBtn" class="bg-blue-600 text-white px-4 py-2 rounded">OK</button>
    </div>`;
  document.body.appendChild(alertModal);
  const alertMessage = alertModal.querySelector('#alertMessage');
  const alertOkBtn = alertModal.querySelector('#alertOkBtn');
  alertOkBtn.addEventListener('click', () => alertModal.classList.add('hidden'));
  function showAlert(msg, type='Info') {
    alertMessage.innerHTML = `<strong>${type}:</strong> ${msg}`;
    alertModal.classList.remove('hidden');
  }

  // ===== CONFIRM MODAL =====
  const confirmModal = document.createElement('div');
  confirmModal.className = 'fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50';
  confirmModal.innerHTML = `
    <div class="bg-white p-6 rounded shadow-lg w-80 text-center">
      <div id="confirmMessage" class="mb-4"></div>
      <div class="flex justify-around">
        <button id="confirmYesBtn" class="bg-green-600 text-white px-4 py-2 rounded">Yes</button>
        <button id="confirmNoBtn" class="bg-red-600 text-white px-4 py-2 rounded">No</button>
      </div>
    </div>`;
  document.body.appendChild(confirmModal);
  const confirmMessage = confirmModal.querySelector('#confirmMessage');
  const confirmYesBtn = confirmModal.querySelector('#confirmYesBtn');
  const confirmNoBtn = confirmModal.querySelector('#confirmNoBtn');
  function showConfirm(msg) {
    return new Promise(resolve => {
      confirmMessage.innerText = msg;
      confirmModal.classList.remove('hidden');
      confirmYesBtn.onclick = () => { confirmModal.classList.add('hidden'); resolve(true); };
      confirmNoBtn.onclick = () => { confirmModal.classList.add('hidden'); resolve(false); };
    });
  }

  // ===== Track viewed order details =====
  async function markOrderAsViewed(orderId) {
  const user = firebase.auth().currentUser;
  if (!user) return;

  try {
    await db.collection("orders").doc(orderId).update({
      [`viewedBy.${user.uid}`]: true
    });
  } catch (err) {
    console.error("Failed to mark order as viewed:", err);
  }
}

  // ===== GLOBAL LOADER =====
function showLoader() {
    detailModal.classList.add("hidden");
  loader.classList.remove("hidden");
  document.body.style.overflow = "hidden";
}

function hideLoader() {
  loader.classList.add("hidden");
  document.body.style.overflow = "";
}

function lockBackground() {
  document.body.style.overflow = "hidden";
}

function unlockBackground() {
  document.body.style.overflow = "";
}

  function capitalize(str) { return str.charAt(0).toUpperCase() + str.slice(1); }
  function escapeHtml(str) { return str?.toString()?.replace(/[&<"']/g, m => ({'&':'&amp;','<':'&lt;','"':'&quot;',"'":'&#039;'}[m])) || ''; }

  function shipmentTimelineHtml(status) {
    const steps = ['processing','shipped','delivered'];
    return `<div class="flex items-center gap-4">${steps.map((s, idx) => {
      const done = steps.indexOf(status) >= idx;
      return `<div class="flex items-center gap-3">
        <span class="timeline-step ${done ? 'bg-green-600' : 'bg-gray-300'}"></span>
        <div class="${done ? 'text-green-700 font-semibold' : 'text-gray-600'} text-sm">${capitalize(s)}</div>
      </div>`;
    }).join('<span class="text-gray-300">â†’</span>')}</div>`;
  }

  // ===== Build Query for Orders =====
function buildQuery(pageSize = PAGE_SIZE, startAfterDoc = null) {
  let q = db.collection('orders').orderBy('createdAt', 'desc');

  // Filters
  if (activeFilters.status && activeFilters.status !== 'all') {
    q = q.where('shipping.status', '==', activeFilters.status);
  }
  if (activeFilters.payment && activeFilters.payment !== 'all') {
    q = q.where('payment.method', '==', activeFilters.payment);
  }
  if (activeFilters.shipment && activeFilters.shipment !== 'all') {
    q = q.where('shipping.status', '==', activeFilters.shipment);
  }
  if (activeFilters.from) {
    q = q.where(
      'createdAt',
      '>=',
      firebase.firestore.Timestamp.fromDate(new Date(activeFilters.from + 'T00:00:00'))
    );
  }
  if (activeFilters.to) {
    q = q.where(
      'createdAt',
      '<=',
      firebase.firestore.Timestamp.fromDate(new Date(activeFilters.to + 'T23:59:59'))
    );
  }
  if (startAfterDoc) q = q.startAfter(startAfterDoc);

  return q.limit(pageSize);
}

  function hideLoadMore() {
  loadMoreBtn.style.display = "none";
}

function showLoadMore() {
  loadMoreBtn.style.display = "inline-block";
}

  async function clearAndLoad() { 
  showLoader(); 
  ordersTbody.innerHTML = ''; 
  lastDoc = null;
  showLoadMore();

  try {
    await loadMore(true);
  } finally {
    hideLoader();
  }
}

  // function updateSummary() {
  //   const rows = Array.from(ordersTbody.children).filter(r => r.__order);
  //   const totalOrders = rows.length;
  //   const totalDeliveryFee = rows.reduce((sum, r) => sum + getDeliveryFee(r.__order), 0);
  //   const totalWeight = rows.reduce((sum, r) => sum + (r.__order.totalWeight||0), 0);
  //   ordersSummary.innerHTML = `<strong>Total Orders:</strong> ${totalOrders} | <strong>Total Delivery Fee:</strong> â‚¦${totalDeliveryFee.toLocaleString()} | <strong>Total Weight:</strong> ${totalWeight} kg`;
  // }

  // ===== Load Orders (Initial + Load More) =====
async function loadMore(isInitial = false) {
  if (loadingMore) return;
  loadingMore = true;
  loadMoreBtn.disabled = true;
  if (isInitial) showLoader();

  try {
    const snap = await buildQuery(PAGE_SIZE, lastDoc).get();
    if (!snap.empty) {
      if (isInitial) ordersTbody.innerHTML = '';
      const docs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      docs.forEach(order => ordersTbody.appendChild(orderRow(order)));
      lastDoc = snap.docs[snap.docs.length - 1];

      if (snap.size < PAGE_SIZE) hideLoadMore();
      else showLoadMore();
    } else if (isInitial) {
      ordersTbody.innerHTML = `<tr><td colspan="8" class="p-4 text-center text-gray-500">No orders found.</td></tr>`;
      hideLoadMore();
    }
  } catch (err) {
    console.error(err);
    ordersTbody.innerHTML = `<tr><td colspan="8" class="p-4 text-red-500">Failed to load orders.</td></tr>`;
  } finally {
    loadingMore = false;
    loadMoreBtn.disabled = false;
    hideLoader();
    // updateSummary();
  }
}

  // ===== Order Row Renderer =====
function orderRow(order) {
  const tr = document.createElement('tr');
  const when = order.createdAt?.toDate?.()?.toLocaleString() || '';
  const adminId = firebase.auth().currentUser?.uid;
  const isNew = !order.viewedBy || !order.viewedBy[adminId];

  // Get nested fields safely
  const name = order.shipping ? `${order.shipping.firstName || ''} ${order.shipping.lastName || ''}` : 'Guest';
  const email = order.shipping?.email || '';
  const phone = order.shipping?.phone || '';
  const paymentMethod = order.payment?.method || '';
  const paymentRef = order.payment?.reference || '';
  const shipmentStatus = order.shipping?.status || 'processing';
  const total = Number(order.pricing?.total || 0);

  tr.innerHTML = `
    <td class="p-2 border border-gray-300">${when}</td>
    <td class="p-2 border border-gray-300">
      <div class="flex items-center gap-2">
        <span>${name}</span>
        ${isNew ? `<span class="px-2 py-0.5 text-xs font-semibold rounded-full bg-red-600 text-white animate-pulse">NEW</span>` : ''}
      </div>
    </td>
    <td class="p-2 border border-gray-300">â‚¦${total.toLocaleString()}</td>
    <td class="p-2 border border-gray-300">${paymentMethod}</td>
    <td class="p-2 border border-gray-300">${shipmentStatus}</td>
    <td class="p-2 border border-gray-300">
      <span class="px-2 py-1 rounded text-xs ${order.fulfilled ? 'bg-green-200 text-green-800' : 'bg-yellow-200 text-yellow-800'}">
        ${order.fulfilled ? 'Completed' : 'Pending'}
      </span>
    </td>
    <td class="p-2 border border-gray-300">
      <div class="flex flex-col md:flex-row gap-2">
        <button class="bg-blue-600 text-white px-3 py-1 rounded" onclick='openDetail("${order.id}")'>Detail</button>
        <button class="bg-pink-500 text-white px-3 py-1 rounded" onclick='toggleFulfilled("${order.id}", ${!!order.fulfilled})'>
          ${order.fulfilled ? "Mark Pending" : "Mark Complete"}
        </button>
      </div>
    </td>
  `;
  tr.__order = order;
  return tr;
}

  // ===== DELETE & TOGGLE =====
  window.deleteOrder = async function(orderId) {
    if(!window.isAdmin) return showAlert("Only admins can delete orders","Error");
    const confirmed = await showConfirm("Are you sure you want to delete this order?");
    if(!confirmed) return;
    try {
      await db.collection('orders').doc(orderId).delete();
      showAlert("Order deleted successfully!","Success");
      clearAndLoad();
    } catch(err){ showAlert("Failed to delete order: "+err.message,"Error"); }
  };

  window.toggleFulfilled = async function(orderId, oldStatus){
    if(!window.isAdmin) return showAlert("Only admins can update orders","Error");
    try {
      await db.collection('orders').doc(orderId).update({ fulfilled: !oldStatus });
      const row = Array.from(ordersTbody.children).find(r => r.__order?.id === orderId);
      if(row){
        row.__order.fulfilled = !oldStatus;
        const newRow = orderRow(row.__order);
        ordersTbody.replaceChild(newRow, row);
      }
      // updateSummary();
    } catch(err){ showAlert("Failed to update order: "+err.message,"Error"); }
  };

  // Update Shipment Status
  function updateShipmentStatus(orderId, newStatus) {
  if (!window.isAdmin) return showAlert("Only admins can update shipment status", "Error");

  // 1ï¸âƒ£ Update Firestore
  const orderRef = db.collection("orders").doc(orderId);
  orderRef
    .update({ 'shipping.status': newStatus,
      shipmentStatus: firebase.firestore.FieldValue.delete()
     })
    .then(() => {
      // 2ï¸âƒ£ Update local row immediately
      const row = Array.from(ordersTbody.children).find(r => r.__order?.id === orderId);
      if (row) {
        row.__order.shipping = row.__order.shipping || {};
        row.__order.shipping.status = newStatus;

        const newRow = orderRow(row.__order);
        ordersTbody.replaceChild(newRow, row);
      }

      // 3ï¸âƒ£ Update modal if open
      if (currentOpenOrder?.id === orderId) {
        currentOpenOrder.shipping = currentOpenOrder.shipping || {};
        currentOpenOrder.shipping.status = newStatus;
        renderModal(currentOpenOrder);
      }

      showAlert("Shipment status updated successfully!", "Success");
      // updateSummary();
    })
    .catch(err => showAlert("Failed to update shipment status: " + err.message, "Error"));
}

  // ===== DETAIL MODAL =====
  window.openDetail = function (orderId) {
  const row = Array.from(ordersTbody.children).find(
    (r) => r.__order?.id === orderId
  );
  if (!row) return;

  currentOpenOrder = row.__order;

  // âœ… Mark as viewed
  markOrderAsViewed(orderId);

  // ðŸ”„ Refresh the row to remove badge
  const newRow = orderRow(currentOpenOrder);
  ordersTbody.replaceChild(newRow, row);

  renderModal(currentOpenOrder);
};

  // ===== Confirm International Payment =====
  async function confirmInternationalPayment(orderId) {
  if (!orderId) throw new Error('Invalid order ID');

  const orderRef = firebase.firestore().collection('orders').doc(orderId);

  await orderRef.update({
    'delivery.fulfilled': true,
    'shipmentStatus': 'processing'
  });
}

// ===== Update International Delivery =====
async function updateInternationalDelivery(orderId, updatedDelivery) {
  if (!orderId) throw new Error('Invalid order ID');
  if (!updatedDelivery) throw new Error('No delivery info provided');

  const orderRef = firebase.firestore().collection('orders').doc(orderId);

  const fee = Number(updatedDelivery.deliveryFee) || 0;

  await orderRef.update({
    'delivery.deliveryFee': fee,
    'delivery.type': updatedDelivery.type || 'home'
  });
}

// Get Delivery Fee
function getDeliveryFee(order) {
  const delivery = order?.delivery || {};
  const country = (delivery.country || '').toLowerCase();

  // Detect international properly
  const isInternational = country && country !== 'nigeria';

  // International: use updated delivery fee
  if (isInternational) {
    return delivery.deliveryFee != null
      ? Number(delivery.deliveryFee)
      : 0;
  }

  // Local/Nigeria
  if (delivery.deliveryFee != null) {
    return Number(delivery.deliveryFee);
  }

  if (order?.deliveryFee != null) {
    return Number(order.deliveryFee);
  }

  return 0;
}

// ===== Render Detail Modal =====
function renderModal(order) {
  currentOpenOrder = order;

  const detailContent = document.getElementById("detailContent");
  const modalStatusControls = document.getElementById("modalStatusControls");
  const detailModal = document.getElementById("detailModal");
  const emailReceiptBtn = document.getElementById("emailReceiptBtn");
  const internationalControls = document.getElementById("internationalControls");

  internationalControls.innerHTML = '';

  detailModal.addEventListener("click", (e) => {
    if (e.target === detailModal) {
      closeDetailModal();
    }
  });

  // Enable email button
  emailReceiptBtn.disabled = false;
  emailReceiptBtn.classList.remove("opacity-50", "cursor-not-allowed");

  emailReceiptBtn.onclick = async () => {
    if (!currentOpenOrder) return showAlert("No order selected", "Error");
    try {
      emailReceiptBtn.disabled = true;
      emailReceiptBtn.innerText = "Sending...";
      await sendReceiptEmail(currentOpenOrder);
      showAlert("Receipt email sent successfully!", "Success");
    } catch (err) {
      showAlert(err.message || "Failed to send receipt email", "Error");
    } finally {
      emailReceiptBtn.disabled = false;
      emailReceiptBtn.innerText = "Email Receipt";
    }
  };

  // ===== SAFE DATA EXTRACTION FROM FIRESTORE STRUCTURE =====
  const shipping = order.shipping || {};
  const delivery = order.delivery || {};
  const pricing = order.pricing || {};
  const items = order.items || [];

  const subtotal = Number(pricing.subtotal || 0);
  const shippingFee = Number(pricing.shippingFee || 0);
  const orderTotal = Number(pricing.total || (subtotal + shippingFee));

  const totalWeight = items.reduce((sum, item) => {
    return sum + (Number(item.weight || 0) * Number(item.quantity || 1));
  }, 0);

  const deliveryFee = getDeliveryFee(order);

  function isInternationalOrder(order) {
  const delivery = order?.delivery || {};
  const country = (delivery.country || '').toLowerCase().trim();

  return country && country !== 'nigeria';
}

const totalWithFee = isInternationalOrder(order)
  ? orderTotal + (order.delivery.deliveryFee || 0)
  : orderTotal;

  // ===== Header =====
  const headerHtml = `<div class="flex justify-between items-center">
    <div>
      <div class="text-lg font-semibold">
        ${escapeHtml(shipping.firstName || '')} ${escapeHtml(shipping.lastName || '')}
      </div>
      <div class="text-xs text-gray-600">
        ${escapeHtml(shipping.email || '')} â€¢ ${escapeHtml(shipping.phone || '')}
      </div>
      <div class="text-xs text-gray-600 mt-1">
        Ref: ${escapeHtml(order.payment?.reference || '')}
      </div>
    </div>
    <div class="text-right">
      <div class="text-sm">Total</div>
      <div class="text-xl font-bold">
        â‚¦${totalWithFee.toLocaleString()}
      </div>
    </div>
  </div>`;

  // ===== Items =====
  const itemsHtml = items.map(i => `
    <div class="flex justify-between border-b py-2">
      <div>
        <div class="font-medium">${escapeHtml(i.name)}</div>
        <div class="text-xs text-gray-600">
          â‚¦${Number(i.price).toLocaleString()} each
        </div>
      </div>
      <div class="text-right">
        <div>${i.quantity} Ã—</div>
        <div class="font-semibold">
          â‚¦${(Number(i.price) * Number(i.quantity)).toLocaleString()}
        </div>
      </div>
    </div>
  `).join('');

  const prog = shipmentTimelineHtml(order.shipping?.status || 'processing');

  let deliveryText = '';

  // International Delivery
  if ((delivery.country || '').toLowerCase() !== 'nigeria') {

  deliveryText = `Company: ${delivery.company || 'International'}<br>
                  Type: ${delivery.type || 'â€”'}<br>
                  Terminal: ${delivery.terminal || 'â€”'}<br>
                  Country: ${delivery.country || 'â€”'}<br>
                  State: ${delivery.state || 'â€”'}<br>
                  Address: ${delivery.address || 'â€”'}`;

  if (!delivery.fulfilled) {
    deliveryText += `<br>
      <span class="text-sm text-blue-600 font-medium">
        Update Available
      </span>`;
  }

  if (delivery.fulfilled && (!delivery.deliveryFee || delivery.deliveryFee === 0)) {
    deliveryText += `<br>
      <span class="inline-block mt-2 px-3 py-1 rounded-full
        bg-green-100 text-green-700 text-xs font-semibold">
        Awaiting Admin Fee Update
      </span>`;
  }

    // Lagos Delivery
    } else if (
  (delivery.state || '').toLowerCase().includes('lagos')
) {
  deliveryText = `Home Delivery<br>
                  LGA: ${delivery.lga || shipping.lga || 'â€”'}<br>
                  Address: ${delivery.address || shipping.street || 'â€”'}`;

    // InterState Delivery
  } else if (delivery.company) {

    if (delivery.type === 'home') {
      deliveryText = `Company: ${delivery.company || 'â€”'}<br>
                      Type: Home Delivery<br>
                      State: ${delivery.state || 'â€”'}<br>
                      Address: ${delivery.address || 'â€”'}`;
    } else if (delivery.type === 'terminal') {
      deliveryText = `Company: ${delivery.company || 'â€”'}<br>
                      Type: Terminal Pickup<br>
                      Terminal: ${delivery.terminal || 'â€”'}<br>
                      State: ${delivery.state || 'â€”'}`;
    } else {
      deliveryText = `Company: ${delivery.company || 'â€”'}<br>
                      Type: ${delivery.type || 'â€”'}<br>
                      State: ${delivery.state || 'â€”'}<br>
                      Address: ${delivery.address || 'â€”'}`;
    }
  }

  const deliveryHtml = `
    <div class="mt-4">
      <h4 class="font-semibold">Delivery</h4>
      <p class="text-sm text-gray-600">${deliveryText}</p>
      <div class="mt-2">${prog}</div>
      <div class="mt-2 text-sm text-gray-700">
  Fee: â‚¦${
    isInternationalOrder(order) 
      ? (order.delivery.deliveryFee || 0).toLocaleString() 
      : (pricing.shippingFee || 0).toLocaleString()
  }<br>
  Weight: ${totalWeight} kg
</div>

    </div>
  `;

  const paymentHtml = `
    <div class="mt-4">
      <h4 class="font-semibold">Payment</h4>
      <p class="text-sm text-gray-600">
        ${escapeHtml(order.payment?.method || '')}
      </p>
      <p class="text-sm text-gray-600">
        Ref: ${escapeHtml(order.payment?.reference || '')}
      </p>
    </div>
  `;

  detailContent.innerHTML = `
    <div class="mt-3">
      ${headerHtml}
      <div class="mt-4">
        <h4 class="font-semibold">Items</h4>
        <div class="mt-2">
          ${itemsHtml || '<div class="text-gray-500">No items listed</div>'}
        </div>
      </div>
      ${deliveryHtml}
      ${paymentHtml}
    </div>`;

  // ===== MODAL STATUS CONTROLS (UNCHANGED) =====
  modalStatusControls.innerHTML = '';

  const sel = document.createElement('select');
  sel.className = 'border p-2 rounded';
  sel.innerHTML = `
    <option value="processing">Processing</option>
    <option value="shipped">Shipped</option>
    <option value="delivered">Delivered</option>
  `;
  sel.value = order.shipmentStatus || 'processing';
  sel.onchange = () => updateShipmentStatus(order.id, sel.value);
  modalStatusControls.appendChild(sel);

  if (window.isAdmin) {

  const delBtn = document.createElement('button');
  delBtn.className = 'ml-2 bg-red-600 text-white px-3 py-2 rounded';
  delBtn.innerText = 'Delete Order';
  delBtn.onclick = () => deleteOrder(order.id);
  modalStatusControls.appendChild(delBtn);

  // âœ… Correct international detection
  if (isInternationalOrder(order)) {

    const adminControls = document.createElement('div');
    adminControls.className =
      'mt-3 p-4 border rounded-lg bg-gray-50 flex flex-col gap-2';

    const title = document.createElement('div');
    title.className = 'font-semibold text-sm text-gray-700';
    title.innerText = 'International Order Control';
    adminControls.appendChild(title);

    // ===== Confirm Payment Button =====
    const confirmPaymentBtn = document.createElement('button');
    confirmPaymentBtn.className =
      'bg-green-600 text-white px-3 py-2 rounded';

    confirmPaymentBtn.innerText = delivery.fulfilled
      ? 'Payment Confirmed'
      : 'Confirm Payment';

    confirmPaymentBtn.disabled = !!delivery.fulfilled;

    confirmPaymentBtn.onclick = async () => {
      try {
        await confirmInternationalPayment(order.id);
        confirmPaymentBtn.innerText = 'Payment Confirmed';
        confirmPaymentBtn.disabled = true;
        showAlert('Payment confirmed successfully!', 'Success');
      } catch (err) {
        showAlert(err.message || 'Failed to confirm payment', 'Error');
      }
    };

    adminControls.appendChild(confirmPaymentBtn);

    // ===== Delivery Fee Input =====
    const feeInput = document.createElement('input');
    feeInput.type = 'number';
    feeInput.placeholder = 'Delivery Fee';
    feeInput.value = delivery.deliveryFee || 0;
    feeInput.className = 'border p-2 rounded';
    adminControls.appendChild(feeInput);

    // ===== Delivery Type Select =====
    const deliverySelect = document.createElement('select');
    deliverySelect.className = 'border p-2 rounded';

    deliverySelect.innerHTML = `
      <option value="home" ${delivery.type === 'home' ? 'selected' : ''}>Home</option>
      <option value="terminal" ${delivery.type === 'terminal' ? 'selected' : ''}>Terminal</option>
    `;

    adminControls.appendChild(deliverySelect);

    // ===== Save Button =====
    const saveBtn = document.createElement('button');
    saveBtn.className =
      'bg-blue-600 text-white px-3 py-2 rounded';
    saveBtn.innerText = 'Update Delivery';

    saveBtn.onclick = async () => {
  try {
    // Get fee and type from inputs
    let feeValue = Number(feeInput.value);
    if (isNaN(feeValue) || feeValue < 0) {
      feeValue = 0;
    }

    const updatedDelivery = {
      deliveryFee: feeValue,
      type: deliverySelect.value || 'home',
    };

    // Save to Firestore
    await updateInternationalDelivery(order.id, updatedDelivery);

    // Update local delivery object so modal reflects new data
    order.delivery.deliveryFee = updatedDelivery.deliveryFee;
    order.delivery.type = updatedDelivery.type;

    showAlert('Delivery updated successfully!', 'Success');
  } catch (err) {
    showAlert(err.message || 'Failed to update delivery', 'Error');
  }
};

    adminControls.appendChild(saveBtn);

    modalStatusControls.appendChild(adminControls);
  }
}

  detailModal.classList.remove('hidden');
  detailModal.classList.add('flex');
  lockBackground();
}

// ===== CLOSE MODAL =====
function closeDetailModal() {
  detailModal.classList.add("hidden");
  detailModal.classList.remove("flex");
  currentOpenOrder = null;
  unlockBackground();
}

modalClose.onclick = closeDetailModal;

  document.getElementById('applyFilters').onclick = () => {
    activeFilters.q = qText.value;
    activeFilters.status = filterStatus.value;
    activeFilters.payment = filterPayment.value;
    activeFilters.shipment = filterShipment.value;
    activeFilters.from = dateFrom.value;
    activeFilters.to = dateTo.value;
    clearAndLoad();
  };

  document.getElementById('clearFilters').onclick = () => {
    qText.value=''; filterStatus.value='all'; filterPayment.value='all'; filterShipment.value='all';
    dateFrom.value=''; dateTo.value=''; activeFilters={}; clearAndLoad();
  };

  loadMoreBtn.onclick = () => loadMore();
  document.getElementById('refreshBtn').onclick = () => clearAndLoad();

  // ===== REAL-TIME UPDATES =====
db.collection('orders').orderBy('createdAt','desc').onSnapshot(snap => {
  snap.docChanges().forEach(change => {
    const order = { id: change.doc.id, ...change.doc.data() };

    if (change.type === 'added') {
      ordersTbody.appendChild(orderRow(order));
    }

    if (change.type === 'modified') {
      const row = Array.from(ordersTbody.children).find(r => r.__order?.id === order.id);
      if (row) ordersTbody.replaceChild(orderRow(order), row);
      if (currentOpenOrder?.id === order.id) renderModal(order);
    }

    if (change.type === 'removed') {
      const row = Array.from(ordersTbody.children).find(r => r.__order?.id === order.id);
      if (row) row.remove();
      if (currentOpenOrder?.id === order.id) {
        detailModal.classList.add('hidden');
        currentOpenOrder = null;
      }
    }
  });
  // updateSummary();
});

  // Email Receipt
  async function sendReceiptEmail(orderId, customerEmail) {
  const res = await fetch("/api/send-receipt", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({orderId, email: customerEmail})
  });

  if (!res.ok) throw new Error("Failed to send email");
  return res.json();
}

// Email Receipt
async function sendReceiptEmail(order) {
  if (!window.isAdmin) throw new Error("Only admins can send emails.");

  try {
    // ===== SAFE DATA EXTRACTION =====
    const shipping = order.shipping || {};
    const payment = order.payment || {};
    const delivery = order.delivery || {};
    const items = order.items || [];
    const pricing = order.pricing || {};

    const fullName = `${shipping.firstName || ''} ${shipping.lastName || ''}`.trim() || order.name || "Customer";
    const email = shipping.email || order.email || "no-email@example.com";
    const phone = shipping.phone || order.phone || "â€”";
    const paymentMethod = payment.method || order.paymentMethod || "â€”";
    const paymentRef = payment.reference || order.paymentRef || order.id;

    // ===== CALCULATE ITEM TOTALS =====
    const orderItemsHtml = items.map(i => `
      <tr>
        <td>${i.name || 'â€”'}</td>
        <td align="center">${i.quantity || 0}</td>
        <td align="right">â‚¦${Number(i.price || 0).toLocaleString()}</td>
        <td align="right">â‚¦${(Number(i.price || 0) * (i.quantity || 0)).toLocaleString()}</td>
      </tr>
    `).join('');

        // ===== CALCULATE DELIVERY FEE, TOTAL WEIGHT, ORDER TOTAL =====
    const deliveryFee = Number(
      delivery.deliveryFee ?? pricing.shippingFee ?? 0
    );

    const totalWeight = Number(order.totalWeight ?? items.reduce((sum, i) => sum + ((i.weight || 0) * (i.quantity || 0)), 0));
    const subtotal = items.reduce((sum, i) => sum + ((Number(i.price) || 0) * (i.quantity || 0)), 0);
    const orderTotal = Number(order.total ?? subtotal + deliveryFee);

    // ===== TEMPLATE PARAMS =====
    const templateParams = {
      to_email: email,
      customer_name: fullName,
      order_id: paymentRef,

      logo_url: "https://res.cloudinary.com/dut2dpxuc/image/upload/v1764188839/e1232d47-ee66-47c9-97fa-b9b86232fb80_n35lqo.png",

      order_name: fullName,
      order_email: email,
      order_phone: phone,

      payment_method: paymentMethod,
      payment_ref: paymentRef,

      order_items: orderItemsHtml,
      order_total: orderTotal.toLocaleString(),

      delivery_company: delivery.company || "â€”",
      delivery_type: delivery.type || "â€”",
      delivery_terminal: delivery.terminal || "â€”",
      delivery_state: delivery.state || "â€”",
      delivery_lga: delivery.lga || "â€”",
      delivery_address: delivery.address || "â€”",
      delivery_fee: deliveryFee.toLocaleString(),
      total_weight: totalWeight
    };

    // ===== SEND EMAIL =====
    const result = await emailjs.send(
      "service_k1xpqh8",   // EmailJS service ID
      "template_nlno322",  // Order Receipt template
      templateParams
    );

    return result;

  } catch (err) {
    console.error("EmailJS error:", err);
    throw new Error(err.text || "Failed to send email via EmailJS");
  }
}

//   // ===== DOWNLOAD Receipt =====
async function downloadPdf(order) {
  if (!order) return;

  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p", "mm", "a4");

    const dark = "#222222";
    const gray = "#555555";
    const gold = "#d4a017";
    const rowLight = "#f7f7f7";

    const pageWidth = doc.internal.pageSize.getWidth();
    const margin = 15;
    let y = 20;

    // ===== LOGO =====
    const logoURL = "https://res.cloudinary.com/dut2dpxuc/image/upload/v1764188839/e1232d47-ee66-47c9-97fa-b9b86232fb80_n35lqo.png";
    const response = await fetch(logoURL);
    const blob = await response.blob();
    const base64Logo = await new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
    const logoWidth = 50, logoHeight = 25, logoX = (pageWidth - logoWidth)/2;
    doc.addImage(base64Logo, "PNG", logoX, 10, logoWidth, logoHeight);
    y = 45;

    // ===== ORDER TITLE =====
    doc.setFont("helvetica","bold");
    doc.setFontSize(18);
    doc.setTextColor(dark);
    doc.text("ORDER RECEIPT", margin, y);
    y += 15;

    // ===== HORIZONTAL LINE =====
    doc.setDrawColor("#e0e0e0");
    doc.setLineWidth(0.5);
    doc.line(margin, y, pageWidth - margin, y);
    y += 5;

    // ===== CUSTOMER INFO =====
    const shipping = order.shipping || {};
    const fullName = `${shipping.firstName || order.name || ''} ${shipping.lastName || ''}`.trim() || "Customer";
    const email = shipping.email || order.email || "â€”";
    const phone = shipping.phone || order.phone || "â€”";
    const paymentRef = order.payment?.reference || order.paymentRef || order.id;

    doc.setFillColor("#f9f9f9");
    doc.roundedRect(margin, y, pageWidth - margin*2, 45, 3, 3, "F");
    doc.setFontSize(12);
    doc.setTextColor(dark);
    y += 10;

    doc.text(`Name: ${fullName}`, margin+5, y); y+=7;
    doc.text(`Email: ${email}`, margin+5, y); y+=7;
    doc.text(`Phone: ${phone}`, margin+5, y); y+=7;
    doc.text(`Payment Ref: ${paymentRef}`, margin+5, y);
    y += 15;

    // ===== TABLE HEADER =====
    const tableX = margin;
    const tableWidth = pageWidth - margin*2;
    const rowHeight = 8;

    doc.setDrawColor("#e0e0e0");
    doc.setLineWidth(0.5);
    doc.setFillColor(gold);
    doc.setTextColor("#ffffff");
    doc.setFontSize(11);
    doc.rect(tableX, y, tableWidth, rowHeight, "F");
    doc.text("Item", tableX + 2, y + 6);
    doc.text("Qty", tableX + 80, y + 6);
    doc.text("Price", tableX + 110, y + 6, { align: "right" });
    doc.text("Total", tableX + 150, y + 6, { align: "right" });
    y += rowHeight;

    // ===== ITEM ROWS =====
    const items = order.items || [];
    doc.setTextColor("#000000");
    items.forEach((i, index) => {
      if (y > 260) { doc.addPage(); y = 20; }
      if (index % 2 === 0) { doc.setFillColor(rowLight); doc.rect(tableX, y, tableWidth, rowHeight, "F"); }
      doc.text(i.name || "â€”", tableX + 2, y + 6);
      doc.text(`${i.quantity || 0}`, tableX + 80, y + 6);
      doc.text(`â‚¦${Number(i.price || 0).toLocaleString()}`, tableX + 110, y + 6, { align: "right" });
      doc.text(`â‚¦${(Number(i.price || 0) * Number(i.quantity || 0)).toLocaleString()}`, tableX + 150, y + 6, { align: "right" });
      doc.rect(tableX, y, tableWidth, rowHeight);
      y += rowHeight;
    });

    // ===== DELIVERY & TOTAL =====
    const delivery = order.delivery || {};
    const deliveryFee = order.delivery?.deliveryFee || order.pricing?.shippingFee || 0;
    const totalWeight = (order.items || []).reduce(
      (sum, item) => sum + (Number(item.weight || 0) * Number(item.quantity || 1)),
      0
    );

    // Total including delivery fee for international orders
    const subtotal = order.total || items.reduce((sum,i)=>sum+(Number(i.price||0)*Number(i.quantity||0)),0);
    const finalTotal = (delivery.country && delivery.country.toLowerCase() !== "nigeria")
      ? subtotal + (deliveryFee || 0)
      : subtotal;

    // Optional delivery fee row
    if (deliveryFee > 0) {
      doc.setFillColor("#f0f0f0");
      doc.rect(tableX, y, tableWidth, rowHeight, "F");
      doc.setFont("helvetica","normal");
      doc.setFontSize(11);
      doc.text("Delivery Fee", tableX + 110, y + 6, { align: "right" });
      doc.text(`â‚¦${deliveryFee.toLocaleString()}`, tableX + 150, y + 6, { align: "right" });
      doc.rect(tableX, y, tableWidth, rowHeight);
      y += rowHeight;
    }

    // Total row
    doc.setFillColor("#eaeaea");
    doc.rect(tableX, y, tableWidth, rowHeight, "F");
    doc.setFont("helvetica", "bold");
    doc.text("Order Total", tableX + 110, y + 6, { align: "right" });
    doc.text(`â‚¦${finalTotal.toLocaleString()}`, tableX + 150, y + 6, { align: "right" });
    doc.rect(tableX, y, tableWidth, rowHeight);
    y += rowHeight + 5;

    // ===== DELIVERY INFO =====
    doc.setFont("helvetica","normal");
    doc.setFontSize(11);
    doc.setTextColor(gray);
    doc.text("Delivery:", margin, y); y += 6;
    if (delivery.type === 'home' && delivery.state?.toLowerCase() === 'lagos') {
      doc.text(`Home Delivery`, margin, y); y += 6;
      doc.text(`LGA: ${delivery.lga || 'â€”'}`, margin, y); y += 6;
      doc.text(`Address: ${delivery.address || 'â€”'}`, margin, y); y += 6;
    } else {
      doc.text(`Company: ${delivery.company?.toUpperCase() || 'â€”'}`, margin, y); y += 6;
      doc.text(`Type: ${delivery.type || 'â€”'}`, margin, y); y += 6;
      doc.text(`Terminal: ${delivery.terminal || 'â€”'}`, margin, y); y += 6;
      doc.text(`State: ${delivery.state || 'â€”'}`, margin, y); y += 6;
      doc.text(`LGA: ${delivery.lga || 'â€”'}`, margin, y); y += 6;
      doc.text(`Address: ${delivery.address || 'â€”'}`, margin, y); y += 6;
    }
    doc.text(`Fee: â‚¦${deliveryFee.toLocaleString()}`, margin, y); y += 6;
    doc.text(`Weight: ${totalWeight} kg`, margin, y); y += 8;

    // ===== PAYMENT INFO =====
    doc.text("Payment:", margin, y); y+=6;
    doc.text(`Method: ${order.payment?.method || order.paymentMethod || 'â€”'}`, margin, y); y+=6;
    doc.text(`Ref: ${order.payment?.reference || order.paymentRef || 'â€”'}`, margin, y); y+=8;

    // ===== FOOTER =====
    y = 285;
    doc.setFontSize(10);
    doc.setTextColor(gray);
    doc.text("Thank you for shopping with Pearl Skin Care!", pageWidth/2, y, { align: "center" });

    doc.save(`Order_${paymentRef}.pdf`);
    showAlert("PDF generated successfully!", "Success");

  } catch(err) {
    showAlert("Failed to generate PDF: "+(err.message||err), "Error");
  }
}

// ===== DOWNLOAD PDF BUTTON =====
const downloadPdfBtn = document.getElementById('downloadPdfBtn');
downloadPdfBtn.onclick = () => {
  if (!currentOpenOrder) return showAlert("No order selected", "Error");
  downloadPdf(currentOpenOrder);
};
  // ===== INITIAL LOAD =====
  clearAndLoad();
</script>
</body>
</html>