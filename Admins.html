<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Admin Panel</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
<!-- Cloudinary Upload Widget -->
<script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
<style>
  table {
  table-layout: fixed;
  width: 100%;
}
</style>
</head>
<body class="bg-gray-100 text-gray-900">

  <!-- Alert/Confirm Modal --> 
  <div id="modalOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50"> 
    <div class="bg-white rounded shadow-lg max-w-sm w-full p-6"> 
      <h3 id="modalTitle" class="text-lg font-bold mb-4">Title</h3> 
      <p id="modalMessage" class="mb-6">Message</p> 
      <div class="flex justify-end space-x-2"> 
        <button id="modalCancelBtn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400 hidden">Cancel</button> 
        <button id="modalOkBtn" class="bg-pink-600 text-white px-4 py-2 rounded hover:bg-pink-700">OK</button> 
      </div> 
    </div> 
  </div> 

  <div class="block fixed w-full z-50 top-0">
  <header class="bg-pink-600 text-white p-4 flex justify-between"> 
    <h1 class="text-xl font-bold">Admin Dashboard</h1> 
    <h2 id="welcomeAdmin" class="text-xl font-bold text-white"></h2> 
  </header> 

  <nav class="bg-gray-200 p-4 flex gap-4 text-sm"> 
    <a href="index.html" class="text-pink-600 hover:underline">üè† Homepage</a> 
    <a href="products.html" class="text-pink-600 hover:underline">üõç View Store</a> 
    <a href="Order-History.html" class="text-pink-600 hover:underline">üìã Order History</a> 
    <a href="Admin-Analytics-Summary.html" class="text-pink-600 hover:underline">üìä Admin Analytics</a>
    <a href="hero.html" class="text-pink-600 flex hover:underline">
      <svg xmlns="http://www.w3.org/2000/svg" class="text-gray-900 mr-1" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M19 8.25h-7a.75.75 0 0 1 0-1.5h7a.75.75 0 0 1 0 1.5m-9 0H5a.75.75 0 0 1 0-1.5h5a.75.75 0 0 1 0 1.5"/><path fill="currentColor" d="M10 9.75A.76.76 0 0 1 9.25 9V6a.75.75 0 0 1 1.5 0v3a.76.76 0 0 1-.75.75m9 7.5h-7a.75.75 0 0 1 0-1.5h7a.75.75 0 0 1 0 1.5m-9 0H5a.75.75 0 0 1 0-1.5h5a.75.75 0 0 1 0 1.5"/><path fill="currentColor" d="M10 18.75a.76.76 0 0 1-.75-.75v-3a.75.75 0 0 1 1.5 0v3a.76.76 0 0 1-.75.75m9-6h-3a.75.75 0 0 1 0-1.5h3a.75.75 0 0 1 0 1.5m-5 0H5a.75.75 0 0 1 0-1.5h9a.75.75 0 0 1 0 1.5"/><path fill="currentColor" d="M14 14.25a.76.76 0 0 1-.75-.75v-3a.75.75 0 0 1 1.5 0v3a.76.76 0 0 1-.75.75"/></svg>
      Hero Slider</a>
    <button onclick="logoutAdmin()" class="ml-auto text-white bg-red-600 px-3 py-1 rounded hover:bg-red-700">Logout</button> 
  </nav> 
  </div>

  <main class="p-6 max-w-4xl mx-auto mt-32">
    <!-- Product Form --> 
    <div class="bg-white shadow p-6 rounded mb-8"> 
      <h2 class="text-lg font-semibold mb-4" id="formTitle">Add New Product</h2> 
      <form id="productForm" class="grid grid-cols-1 md:grid-cols-2 gap-4"> 
        <input type="text" id="name" placeholder="Product Name" class="border p-2 rounded" required /> 
        <input type="number" id="price" placeholder="Price (‚Ç¶)" class="border p-2 rounded" required /> 
        <input type="number" id="weight" placeholder="Weight (kg)" step="0.01" class="border p-2 rounded" required /> 
        <input type="text" id="category" placeholder="Category" class="border p-2 rounded" required /> 
        
        <!-- Image input + Upload button -->
        <div class="flex gap-2">
          <input type="text" id="image" placeholder="Image URL" class="border p-2 rounded flex-1" required /> 
          <button type="button" id="uploadImageBtn" class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600">Upload</button>
        </div>
        
        <textarea id="description" placeholder="Product Description" class="border p-2 rounded md:col-span-2 resize-none" rows="3"></textarea> 
        <button type="submit" class="bg-pink-600 text-white px-4 py-2 rounded md:col-span-2 hover:bg-pink-700 flex justify-center items-center gap-2"> 
          <span id="saveBtnText">Save Product</span> 
          <span id="saveSpinner" class="hidden">
            <i class="fa-solid fa-circle-notch fa-spin"></i>
          </span> 
        </button> 
      </form> 
    </div> 

    <!-- Product Table --> 
    <div class="bg-white shadow p-6 rounded">
      <h2 class="text-lg font-semibold mb-4">Product List</h2> 
      <div class="overflow-auto"> 
        <table class="w-full text-left border"> 
          <thead class="bg-pink-100"> 
            <tr> 
              <th class="p-2">Name</th> 
              <th class="p-2">Price</th> 
              <th class="p-2">Category</th> 
              <th class="p-2">Weight (kg)</th> 
              <th class="p-2">Image</th> 
              <th class="p-2">Description</th> 
              <th class="p-2">Actions</th> 
            </tr> 
          </thead> 
          <tbody id="productTableBody"></tbody>
        </table> 
      </div> 
    </div> 
    <div class="text-center mt-4"> 
      <button id="loadMoreProductsBtn" class="bg-pink-500 text-white px-4 py-2 rounded hover:bg-pink-600">Load More Products</button> 
    </div> 
  </main> 

  <!-- ===== LOADER ===== -->
<div
  id="dashboard-loader"
  class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50"
>
  <i class="fas fa-spinner fa-spin text-white text-5xl"></i>
</div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script> 
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script> 
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
window.addEventListener("load", () => {
  // ===== Firebase config =====
  const firebaseConfig = {
    apiKey: "AIzaSyDdTPmpaIPWSDWOmR-fXgvAb7hoxZUawcc",
    authDomain: "e-commerce-39c74.firebaseapp.com",
    projectId: "e-commerce-39c74",
    storageBucket: "e-commerce-39c74.firebasestorage.app",
    messagingSenderId: "863375033754",
    appId: "1:863375033754:web:7ba248c8dbb1566c83e623"
  };

  const app = firebase.apps.length ? firebase.app() : firebase.initializeApp(firebaseConfig);
  const auth = app.auth();
  const db = app.firestore();

    // ===== Firestore & state =====
  let newOrdersCount = Number(localStorage.getItem("newOrdersCount")) || 0;
  let seenOrders = JSON.parse(localStorage.getItem("seenOrders") || "[]");
  let firstLoadOrders = true;

  // ===== Create notification div dynamically =====
  const notification = document.createElement("div");
  notification.id = "orderNotification";
  Object.assign(notification.style, {
    background: "#FEF3C7",
    color: "#92400E",
    padding: "10px 14px",
    borderRadius: "8px",
    display: "flex",
    alignItems: "center",
    gap: "10px",
    fontSize: "14px",
    position: "fixed",
    top: "15%",
    right: "7%",
    zIndex: "9999",
    opacity: "0",
    transition: "opacity 0.5s ease",
    pointerEvents: "none", // avoid blocking clicks
  });

  const icon = document.createTextNode("üîî");
  const text = document.createElement("span");
  text.id = "newOrderCountText";

  const link = document.createElement("a");
  location.href = "order-history.html";
  link.textContent = "View orders";
  Object.assign(link.style, {
    fontWeight: "600",
    textDecoration: "underline",
    color: "#92400E",
  });

  link.addEventListener("click", () => {
    newOrdersCount = 0;
    localStorage.setItem("newOrdersCount", 0);
    updateOrderNotification();
  });

  notification.appendChild(icon);
  notification.appendChild(text);
  notification.appendChild(link);
  document.body.prepend(notification);

  // ===== Update UI =====
  function updateOrderNotification() {
    if (newOrdersCount > 0) {
      text.textContent =
        newOrdersCount === 1
          ? "You have 1 new order"
          : `You have ${newOrdersCount} new orders`;
      notification.style.pointerEvents = "auto";
      notification.style.opacity = "1";
    } else {
      notification.style.opacity = "0";
      notification.style.pointerEvents = "none";
    }
  }

  // ===== Play sound (your old working code) =====
  function playNewOrderSound() {
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      if (ctx.state === "suspended") ctx.resume();
      const oscillator = ctx.createOscillator();
      oscillator.type = "square";
      oscillator.frequency.setValueAtTime(440, ctx.currentTime);
      oscillator.connect(ctx.destination);
      oscillator.start();
      oscillator.stop(ctx.currentTime + 0.15);
    } catch (err) {
      console.warn("Sound blocked by browser");
    }
  }

  // ===== Firestore listener for new orders =====
  db.collection("orders")
    .orderBy("timestamp", "desc")
    .onSnapshot((snapshot) => {
      snapshot.docChanges().forEach((change) => {
        const orderId = change.doc.id;

        if (change.type === "added" && !seenOrders.includes(orderId)) {
          seenOrders.push(orderId);
          localStorage.setItem("seenOrders", JSON.stringify(seenOrders));

          if (!firstLoadOrders) {
            newOrdersCount++;
            localStorage.setItem("newOrdersCount", newOrdersCount);
            updateOrderNotification();
            playNewOrderSound(); // ‚úÖ sound plays immediately
          }
        }
      });

      firstLoadOrders = false;
      updateOrderNotification();
    });

  // Show stored count on load
  updateOrderNotification();
//   let newOrdersCount = Number(localStorage.getItem("newOrdersCount")) || 0;
//   let seenOrders = JSON.parse(localStorage.getItem("seenOrders") || "[]");
//   let firstLoadOrders = true;

//   // ===== Create notification div dynamically =====
//   const notification = document.createElement("div");
//   notification.id = "orderNotification";

//   Object.assign(notification.style, {
//     background: "#FEF3C7",
//     color: "#92400E",
//     padding: "10px 14px",
//     borderRadius: "8px",
//     display: "none", // start hidden
//     alignItems: "center",
//     gap: "10px",
//     fontSize: "14px",
//     marginBottom: "12px",
//     position: "fixed",
//     top: "10%",
//     right: "7%",
//     zIndex: "9999",
//   });

//   const icon = document.createTextNode("üîî");
//   const text = document.createElement("span");
//   text.id = "newOrderCountText";

//   const link = document.createElement("a");
//   link.href = "order-history.html";
//   link.textContent = "View orders";
//   Object.assign(link.style, {
//     fontWeight: "600",
//     textDecoration: "underline",
//     color: "#92400E",
//   });
//   link.addEventListener("click", () => {
//     newOrdersCount = 0;
//     localStorage.setItem("newOrdersCount", 0);
//     updateOrderNotification();
//   });

//   notification.appendChild(icon);
//   notification.appendChild(text);
//   notification.appendChild(link);

//   const body = document.body || document.getElementsByTagName("body")[0];
//   body.prepend(notification);

//   // ===== Update UI =====
//   function updateOrderNotification() {
//     if (!notification || !text) return;

//     if (newOrdersCount > 0) {
//       text.textContent =
//         newOrdersCount === 1
//           ? "You have 1 new order"
//           : `You have ${newOrdersCount} new orders`;
//       notification.style.display = "flex";
//     } else {
//       notification.style.display = "none";
//     }
//   }

//   function playNewOrderSound() {
//   try {
//     const ctx = new (window.AudioContext || window.webkitAudioContext)();
//     if (ctx.state === "suspended") ctx.resume();
//     const oscillator = ctx.createOscillator();
//     oscillator.type = "square";
//     oscillator.frequency.setValueAtTime(440, ctx.currentTime);
//     oscillator.connect(ctx.destination);
//     oscillator.start();
//     oscillator.stop(ctx.currentTime + 0.15);
//   } catch (err) {
//     console.warn("Sound blocked by browser");
//   }
// }

//   // function playNewOrderSound() {
//   //   try {
//   //     const ctx = new (window.AudioContext || window.webkitAudioContext)();
//   //     if (ctx.state === "suspended") ctx.resume();
//   //     const oscillator = ctx.createOscillator();
//   //     oscillator.type = "square";
//   //     oscillator.frequency.setValueAtTime(440, ctx.currentTime);
//   //     oscillator.connect(ctx.destination);
//   //     oscillator.start();
//   //     oscillator.stop(ctx.currentTime + 0.15);
//   //   } catch (err) {
//   //     console.warn("Sound blocked by browser");
//   //   }
//   // }

//   // ===== Firestore listener =====
//   db.collection("orders")
//     .orderBy("timestamp", "desc")
//     .onSnapshot((snapshot) => {
//       snapshot.docChanges().forEach((change) => {
//         const orderId = change.doc.id;

//         if (change.type === "added" && !seenOrders.includes(orderId)) {
//           seenOrders.push(orderId);
//           localStorage.setItem("seenOrders", JSON.stringify(seenOrders));

//           if (!firstLoadOrders) {
//             newOrdersCount++;
//             localStorage.setItem("newOrdersCount", newOrdersCount);
//             updateOrderNotification();
//             playNewOrderSound();
//           }
//         }
//       });

//       firstLoadOrders = false;
//       updateOrderNotification();
//     });

//   // Show stored count on load
//   updateOrderNotification();

  let editId = null;
  let lastVisibleProduct = null;
  const PRODUCTS_PER_PAGE = 5;

  const modalOverlay = document.getElementById("modalOverlay");
  const modalTitle = document.getElementById("modalTitle");
  const modalMessage = document.getElementById("modalMessage");
  const modalOkBtn = document.getElementById("modalOkBtn");
  const modalCancelBtn = document.getElementById("modalCancelBtn");
  const loader = document.getElementById("dashboard-loader");

  function showAlert(message, title="Alert") {
    modalTitle.textContent = title;
    modalMessage.textContent = message;
    modalCancelBtn.classList.add("hidden");
    modalOverlay.classList.remove("hidden");
    return new Promise(resolve => {
      modalOkBtn.onclick = () => {
        modalOverlay.classList.add("hidden");
        resolve(true);
      };
    });
  }

  function showConfirm(message, title="Confirm") {
    // Set the title
    modalTitle.textContent = title;

    // Render message as HTML instead of plain text
    modalMessage.innerHTML = message;

    // Show cancel button and overlay
    modalCancelBtn.classList.remove("hidden");
    modalOverlay.classList.remove("hidden");

    return new Promise(resolve => {
        modalOkBtn.onclick = () => { 
            modalOverlay.classList.add("hidden"); 
            resolve(true); 
        };
        modalCancelBtn.onclick = () => { 
            modalOverlay.classList.add("hidden"); 
            resolve(false); 
        };
    });
}

  // Loader
function showLoader() {
  loader.classList.remove("hidden");
  document.body.style.overflow = "hidden";
}

function hideLoader() {
  loader.classList.add("hidden");
  document.body.style.overflow = "";
}

  auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

auth.onAuthStateChanged(async (user) => {
  if (!user || localStorage.getItem("isAdminLoggedIn") !== "true") return goToLogin();

  try {
    const adminDoc = await waitForAdminDoc(user.uid);
    if (!adminDoc) {
      await showAlert(
        "Access denied. You are not an admin or your account is not ready yet.",
        "Access Denied"
      );
      await auth.signOut();
      return goToLogin();
    }

    const fullName = adminDoc.data().name || "Admin";
    const firstName = fullName.split(" ")[0];
    const welcomeEl = document.getElementById("welcomeAdmin");
    if (welcomeEl) welcomeEl.textContent = `Welcome, ${firstName}`;
  } catch (err) {
    console.error("Admin auth check failed:", err);
    goToLogin();
  }
});

  // ===== Cloudinary Upload Widget =====
  if (!window.cloudinary) {
    console.error("Cloudinary not loaded. Make sure the script tag is included above this script.");
  } else {
    const cloudName = 'dut2dpxuc';       // Replace with your Cloud Name
    const uploadPreset = 'products'; // Replace with your unsigned preset

    const cloudinaryWidget = window.cloudinary.createUploadWidget({
      cloudName,
      uploadPreset,
      folder: "products",
      multiple: false
    }, (error, result) => {
      if (!error && result && result.event === "success") {
        document.getElementById("image").value = result.info.secure_url;
        showAlert("Image uploaded successfully!", "Success");
      } else if (error) {
        console.error(error);
        showAlert("Image upload failed.", "Error");
      }
    });

    document.getElementById("uploadImageBtn").addEventListener("click", () => cloudinaryWidget.open());
  }

  // ===== Load / Render Products =====
  async function loadProducts(startAfterDoc=null) {
    let query = db.collection("products").orderBy("name").limit(PRODUCTS_PER_PAGE);
    if(startAfterDoc) query = query.startAfter(startAfterDoc);
    const snap = await query.get();
    lastVisibleProduct = snap.docs[snap.docs.length-1];
    return snap.docs.map(d => ({id:d.id, ...d.data()}));
  }

//   // Render Table
// Render Table
async function renderTable(append = false) {
  const tbody = document.getElementById("productTableBody");
  const loadMoreBtn = document.getElementById("loadMoreProductsBtn");

  if (!append) {
    tbody.innerHTML = "";
    showLoader(); // üëà show loader before Firestore fetch
  }

  try {
    const products = await loadProducts(append ? lastVisibleProduct : null);

    products.forEach(p => {
      let imgUrl = p.image && p.image.includes("res.cloudinary.com")
        ? p.image.replace("/upload/", "/upload/w_300,h_300,c_fill/")
        : p.image || "https://via.placeholder.com/300";

      tbody.innerHTML += `
        <tr class="border-b">
          <td class="p-2">${p.name}</td>
          <td class="p-2">‚Ç¶${p.price.toLocaleString()}</td>
          <td class="p-2">${p.category}</td>
          <td class="p-2">${p.weight || 0} kg</td>
          <td class="p-2">
            <img src="${imgUrl}" class="w-12 h-12 object-cover rounded"/>
          </td>
          <td class="p-2 text-sm max-w-xs truncate">${p.description}</td>
          <td class="p-2">
            <button onclick="editProduct('${p.id}')" class="text-blue-600 text-sm">Edit</button>
            <button onclick="deleteProduct('${p.id}')" class="text-red-600 text-sm ml-2">Delete</button>
          </td>
        </tr>`;
    });

    if (!append && products.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td class="p-4 text-center text-gray-500" colspan="7">
            No products found.
          </td>
        </tr>`;
    }

    // ‚úÖ Hide Load More button if no more products
    if (products.length < PRODUCTS_PER_PAGE) {
      loadMoreBtn.classList.add("hidden");
    } else {
      loadMoreBtn.classList.remove("hidden");
    }

  } catch (err) {
    console.error("Error loading products:", err);
    showAlert("Failed to load products.", "Error");
  } finally {
    hideLoader(); // üëà ALWAYS hide loader
  }
}

  // ===== Save Product =====
  const saveBtnText = document.getElementById("saveBtnText");
  const saveSpinner = document.getElementById("saveSpinner");

  document.getElementById("productForm").addEventListener("submit", async e=>{
    e.preventDefault();
    saveBtnText.textContent = "Saving...";
    saveSpinner.classList.remove("hidden");

    const data = {
      name: document.getElementById("name").value.trim(),
      price: parseFloat(document.getElementById("price").value),
      category: document.getElementById("category").value.trim(),
      weight: parseFloat(document.getElementById("weight").value),
      image: document.getElementById("image").value.trim(),
      description: document.getElementById("description").value.trim()
    };

    try {
      if(editId){
        await db.collection("products").doc(editId).update(data);
        editId = null;
        document.getElementById("formTitle").textContent = "Add New Product";
      } else {
        await db.collection("products").add(data);
      }
      document.getElementById("productForm").reset();
      await showAlert("Product saved successfully!", "Success");
      renderTable();
    } catch(err){
      await showAlert("Failed: "+err.message,"Error");
    } finally {
      saveBtnText.textContent = "Save Product";
      saveSpinner.classList.add("hidden");
    }
  });

  // ===== Edit / Delete =====
  window.editProduct = async id=>{
    const doc = await db.collection("products").doc(id).get();
    const p = doc.data();
    document.getElementById("name").value = p.name;
    document.getElementById("price").value = p.price;
    document.getElementById("category").value = p.category;
    document.getElementById("image").value = p.image;
    document.getElementById("description").value = p.description;
    document.getElementById("weight").value = p.weight || 0;
    document.getElementById("formTitle").textContent = "Edit Product";
    editId = id;
  };

  window.deleteProduct = async id=>{
    const confirmed = await showConfirm("Delete this product?");
    if(!confirmed) return;
    await db.collection("products").doc(id).delete();
    renderTable();
  };

  // Redirect to admin login page
function goToLogin() {
  window.location.href = "admin-login.html";
}

window.logoutAdmin = async ()=>{
  await auth.signOut();
  localStorage.removeItem("isAdminLoggedIn");
  window.location.href = "admin-login.html";
};

// Wait for the admin document in Firestore
async function waitForAdminDoc(uid) {
  try {
    const doc = await db.collection("admins").doc(uid).get();
    return doc.exists ? doc : null;
  } catch (err) {
    console.error("Error fetching admin document:", err);
    return null;
  }
}

  // ===== Load More =====
  document.getElementById("loadMoreProductsBtn").addEventListener("click", ()=>renderTable(true));

  // ===== Initial Load =====
  renderTable();

});
</script>
</body>
</html>