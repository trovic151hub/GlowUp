<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Customer Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ===== MOBILE DASHBOARD FIXES ===== */
@media (max-width: 640px) {

  main {
    padding: 1rem !important;
  }

  h2 {
    font-size: 1rem !important;
    text-align: center;
  }

  /* Reduce card spacing */
  .dashboard-card {
    padding: 1rem !important;
  }

  /* Status filter buttons scroll horizontally */
  .status-filter-wrapper {
    overflow-x: auto;
    display: flex;
    gap: 0.5rem;
    padding-bottom: 5px;
  }

  .status-btn {
    white-space: nowrap;
    font-size: 0.75rem;
    padding: 6px 10px !important;
  }

  /* Make table scroll sideways */
  .table-wrapper {
    overflow-x: auto;
  }
  
  table {
    min-width: 300px;
  }

  /* Modal: full screen on mobile */
  #orderModal > div {
    width: 95% !important;
    max-height: 80vh !important;
  }
}
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
<!-- Loader -->
  <div id="dashboard-loader" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50 hidden">
    <svg xmlns="http://www.w3.org/2000/svg" class="fas fa-shopping-cart text-white w-12 h-12 animate-pulse" viewBox="0 0 16 16">
      <path fill="currentColor" d="M0 2.5A.5.5 0 0 1 .5 2H2a.5.5 0 0 1 .485.379L2.89 4H14.5a.5.5 0 0 1 .485.621l-1.5 6A.5.5 0 0 1 13 11H4a.5.5 0 0 1-.485-.379L1.61 3H.5a.5.5 0 0 1-.5-.5M3.14 5l.5 2H5V5zM6 5v2h2V5zm3 0v2h2V5zm3 0v2h1.36l.5-2zm1.11 3H12v2h.61zM11 8H9v2h2zM8 8H6v2h2zM5 8H3.89l.5 2H5zm0 5a1 1 0 1 0 0 2a1 1 0 0 0 0-2m-2 1a2 2 0 1 1 4 0a2 2 0 0 1-4 0m9-1a1 1 0 1 0 0 2a1 1 0 0 0 0-2m-2 1a2 2 0 1 1 4 0a2 2 0 0 1-4 0"/>
    </svg>
  </div>

  <header class="bg-gradient-to-r from-[#fbcfe8] to-[#f9a8d4] p-4 shadow-md flex justify-between items-center fixed top-0 w-full">
    <button onclick="history.back()">
    <h1 class="text-xl font-bold">ðŸ‘¤ My Dashboard</h1>
    </button>
  </header>

  <main class="max-w-4xl mx-auto p-6 mt-16">
    <h2 class="text-lg font-semibold mb-4">Welcome, <span id="userName">Customer</span> ðŸ‘‹</h2>

    <div class="bg-white p-6 rounded shadow">
      <h3 class="text-md font-semibold mb-4">ðŸ“¦ Your Orders</h3>
      <div class="fil mb-4 block gap-2 items-center">
  <span class=" font-semibold">Filter by Status:</span>
  <div>
  <button onclick="filterOrders('All')" class="status-btn bg-pink-100 px-3 py-1 rounded hover:bg-pink-200" data-status="All">All</button>
  <button onclick="filterOrders('Pending')" class="status-btn bg-pink-100 px-3 py-1 rounded hover:bg-pink-200" data-status="Pending">Pending</button>
  <button onclick="filterOrders('Shipped')" class="status-btn bg-pink-100 px-3 py-1 rounded hover:bg-pink-200" data-status="Shipped">Shipped</button>
  <button onclick="filterOrders('Delivered')" class="status-btn bg-pink-100 px-3 py-1 rounded hover:bg-pink-200" data-status="Delivered">Delivered</button>
  </div>
</div>
      <table class="w-full border text-sm">
        <thead class="bg-pink-100">
          <tr>
            <th class="p-2">Date</th>
            <th class="p-2">Total</th>
            <th class="p-2">Items</th>
            <th class="p-2">Action</th>
          </tr>
        </thead>
        <tbody id="orderTableBody"></tbody>
      </table>
    </div>
  </main>

  <div id="overlay" class="hidden fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
  <div class="loader w-12 h-12 border-4 border-pink-500 border-t-transparent rounded-full animate-spin"></div>
</div>

  <!-- Modal -->
  <div id="orderModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center flex justify-center z-50">
    <div class="bg-white w-11/12 max-w-lg p-6 rounded shadow-lg">
      <h2 class="text-xl font-bold mb-4">Order Details</h2>
      <div id="modalContent" class="space-y-2 max-h-[60vh] overflow-y-auto"></div>
      <button onclick="closeModal()" class="mt-4 bg-pink-500 text-white px-4 py-2 rounded hover:bg-pink-600">Close</button>
    </div>
  </div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // ===== 0. Loader =====
  let loader = document.getElementById("dashboard-loader");
  if (!loader) {
    loader = document.createElement("div");
    loader.id = "dashboard-loader";
    loader.className = "fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50 hidden";
    loader.innerHTML = `<i class="fas fa-spinner fa-pulse text-6xl text-white"></i>`;
    document.body.appendChild(loader);
  }

  function showLoader() {
    if (!loader) return;
    loader.style.opacity = "1";
    loader.classList.remove("hidden");
    // Disable scroll & clicks
    document.body.style.overflow = "hidden";
    document.body.style.pointerEvents = "none";
  }

  function hideLoader() {
    if (!loader) return;
    loader.style.opacity = "0";
    loader.style.transition = "opacity 0.4s ease";
    setTimeout(() => {
      loader.classList.add("hidden");
      // Re-enable scroll & clicks
      document.body.style.overflow = "";
      document.body.style.pointerEvents = "";
    }, 400);
  }

  // ===== 1. Globals =====
  const orderTableBody = document.getElementById("orderTableBody");
  const userNameSpan = document.getElementById("userName");
  const orderModal = document.getElementById("orderModal");
  const modalContent = document.getElementById("modalContent");
  const overlay = document.getElementById("overlay");
  const pageSize = 10;

  let currentUser = null;
  let ordersUnsub = null;
  let allOrders = [];
  let currentFilter = "All";
  let currentPage = 1;

  // ===== 2. Firebase Config & Init =====
  const firebaseConfig = {
    apiKey: "AIzaSyDdTPmpaIPWSDWOmR-fXgvAb7hoxZUawcc",
    authDomain: "e-commerce-39c74.firebaseapp.com",
    projectId: "e-commerce-39c74",
    storageBucket: "e-commerce-39c74.firebasestorage.app",
    messagingSenderId: "863375033754",
    appId: "1:863375033754:web:7ba248c8dbb1566c83e623"
  };
  firebase.initializeApp(firebaseConfig);
  const userAuth = firebase.auth();
  const userDb = firebase.firestore();

  // ===== 3. Overlay Functions =====
  function showOverlay() { if (overlay) overlay.classList.remove("hidden"); }
  function hideOverlay() { if (overlay) overlay.classList.add("hidden"); }

  // ===== 4. Auth Listener =====
  userAuth.onAuthStateChanged(user => {
    currentUser = user;
    if (user) {
      const fullName = user.displayName || (user.email ? user.email.split("@")[0] : "Customer");
      const firstName = fullName.charAt(0).toUpperCase() + fullName.slice(1).toLowerCase();
      if (userNameSpan) userNameSpan.textContent = firstName;
      startOrdersListener();
    } else {
      stopOrdersListener();
      renderOrders([]);
      if (userNameSpan) userNameSpan.textContent = "Customer";
      hideLoader();
    }
  });

  // ===== 5. Orders Listener =====
  function startOrdersListener() {
    stopOrdersListener();
    if (!currentUser) return;

    showLoader();

    // Skeleton loader
    if (orderTableBody) {
      orderTableBody.innerHTML = `${[...Array(3)].map(() => `
        <tr class="animate-pulse">
          <td class="p-2 bg-gray-200 h-4 rounded"></td>
          <td class="p-2 bg-gray-200 h-4 rounded"></td>
          <td class="p-2 bg-gray-200 h-4 rounded"></td>
          <td class="p-2 bg-gray-200 h-4 rounded"></td>
        </tr>`).join('')}`;
    }

    const ordersRef = userDb.collection("orders").where("userId", "==", currentUser.uid);

    ordersUnsub = ordersRef.onSnapshot(snapshot => {
      hideLoader();

      if (!snapshot.empty) {
        allOrders = snapshot.docs.map(doc => {
          const data = doc.data();
          const status = data.shipmentStatus || data.status || "Pending";
          return {
            id: doc.id,
            total: data.total || 0,
            items: data.items || [],
            status: status,
            createdAt: data.createdAt || data.timestamp
          };
        });

        allOrders.sort((a, b) => {
          let aDate = a.createdAt || a.timestamp;
          let bDate = b.createdAt || b.timestamp;
          try {
            aDate = aDate?.toDate ? aDate.toDate() : new Date(aDate.seconds * 1000);
            bDate = bDate?.toDate ? bDate.toDate() : new Date(bDate.seconds * 1000);
          } catch {}
          return bDate - aDate;
        });
      } else {
        allOrders = [];
      }

      applyOrderFilter(currentFilter);
    }, error => {
      hideLoader();
      console.error("Failed to fetch orders:", error);
      if (orderTableBody) {
        orderTableBody.innerHTML = `<tr><td colspan="4" class="text-center text-red-500 p-2">Failed to load orders</td></tr>`;
      }
    });
  }

  function stopOrdersListener() {
    if (ordersUnsub) ordersUnsub();
    ordersUnsub = null;
  }

  // ===== 6. Filter Buttons =====
  function filterOrders(status) {
    showLoader(); // Show loader during filtering
    currentFilter = status;
    document.querySelectorAll(".status-btn").forEach(btn => {
      if (btn.dataset.status === status) {
        btn.classList.add("bg-pink-500", "text-white");
        btn.classList.remove("bg-pink-100");
      } else {
        btn.classList.remove("bg-pink-500", "text-white");
        btn.classList.add("bg-pink-100");
      }
    });
    applyOrderFilter(status);
    setTimeout(hideLoader, 400); // Small delay for UX
  }

  // ===== 7. Filter + Pagination =====
  function applyOrderFilter(status) {
    const filtered = status === "All" ? allOrders : allOrders.filter(o => o.status.toLowerCase() === status.toLowerCase());
    currentPage = 1;
    renderPagination(filtered);
    renderOrders(paginateOrders(filtered));
  }

  function paginateOrders(list) {
    const start = (currentPage - 1) * pageSize;
    return list.slice(start, start + pageSize);
  }

  function renderPagination(list) {
    const totalPages = Math.ceil(list.length / pageSize);
    let container = document.getElementById("paginationControls");
    if (!container && orderTableBody) {
      container = document.createElement("div");
      container.id = "paginationControls";
      container.className = "flex items-center gap-2 mt-3 justify-center";
      orderTableBody.parentElement.appendChild(container);
    }

    if (!container) return;

    if (totalPages <= 1) {
      container.innerHTML = "";
      return;
    }

    container.innerHTML = `
      <button onclick="changePage('prev')" class="px-3 py-1 rounded bg-pink-100 hover:bg-pink-200">Prev</button>
      <span class="px-3">Page ${currentPage} of ${totalPages}</span>
      <button onclick="changePage('next')" class="px-3 py-1 rounded bg-pink-100 hover:bg-pink-200">Next</button>
    `;
  }

  function changePage(direction) {
    showLoader(); // Show loader during page change
    const filtered = currentFilter === "All" ? allOrders : allOrders.filter(o => o.status.toLowerCase() === currentFilter.toLowerCase());
    const totalPages = Math.ceil(filtered.length / pageSize);

    if (direction === "next" && currentPage < totalPages) currentPage++;
    if (direction === "prev" && currentPage > 1) currentPage--;

    renderPagination(filtered);
    renderOrders(paginateOrders(filtered));
    setTimeout(hideLoader, 400);
  }

  // ===== 8. Render Orders Table =====
  function renderOrders(orders) {
    if (!orderTableBody) return;
    if (!orders.length) {
      orderTableBody.innerHTML = `<tr><td colspan="4" class="text-center text-gray-500 p-2">No orders found.</td></tr>`;
      return;
    }

    orderTableBody.innerHTML = "";
    orders.forEach(order => {
      let dateStr = "N/A";
      const rawDate = order.createdAt || order.timestamp;
      if (rawDate) {
        if (typeof rawDate.toDate === "function") dateStr = rawDate.toDate().toLocaleDateString();
        else if (rawDate.seconds) dateStr = new Date(rawDate.seconds * 1000).toLocaleDateString();
        else {
          const d = new Date(rawDate);
          if (!isNaN(d)) dateStr = d.toLocaleDateString();
        }
      }

      const totalStr = order.total?.toLocaleString() || "0";
      const itemsCount = order.items?.length || 0;

      const statusColor =
        order.status.toLowerCase() === "pending" ? "bg-yellow-300 text-yellow-800" :
        order.status.toLowerCase() === "shipped" ? "bg-blue-300 text-blue-800" :
        order.status.toLowerCase() === "delivered" ? "bg-green-300 text-green-800" :
        "bg-gray-300 text-gray-800";

      const tr = document.createElement("tr");
      tr.className = "border-b hover:bg-gray-50";
      tr.innerHTML = `
        <td class="p-2 text-center">${dateStr}</td>
        <td class="p-2 text-center">â‚¦${totalStr}</td>
        <td class="p-2 text-center">${itemsCount}</td>
        <td class="p-2 text-center">
          <span class="px-2 py-1 rounded ${statusColor} text-sm font-semibold">${order.status}</span>
          <button onclick="viewOrder('${order.id}')" class="ml-2 text-blue-500 hover:underline">View</button>
        </td>
      `;
      orderTableBody.appendChild(tr);
    });
  }

  // ===== 9. View Order Modal =====
  window.viewOrder = function(orderId) {
    if (!modalContent || !orderModal) return;
    const order = allOrders.find(o => o.id === orderId);
    if (!order) return;

    const rawStatus = order.status.toLowerCase();
    const normalized = rawStatus.includes("process") || rawStatus.includes("pending") ? "Pending" :
                       rawStatus.includes("ship") ? "Shipped" :
                       rawStatus.includes("deliver") ? "Delivered" : "Pending";

    const steps = ["Pending", "Shipped", "Delivered"];
    const index = steps.indexOf(normalized);

    const timeline = steps.map((step, i) => `
      <div class="flex items-center gap-2">
        <div class="w-3 h-3 rounded-full ${i < index ? "bg-green-500" : i === index ? "bg-blue-500" : "bg-gray-300"}"></div>
        <span class="${i === index ? 'font-bold text-blue-600' : ''}">${step}</span>
      </div>
    `).join("");

    modalContent.innerHTML = `
      <h3 class="font-semibold mb-3">Order Progress</h3>
      <div class="space-y-2 mb-4">${timeline}</div>

      <h3 class="font-semibold mb-2">Items</h3>
      ${order.items.map(i => `
        <div class="flex justify-between border-b py-2">
          <div>${i.name}</div>
          <div>${i.quantity} Ã— â‚¦${i.price.toLocaleString()}</div>
        </div>
      `).join('')}

      <div class="mt-3 text-right text-lg font-bold">
        Total: â‚¦${order.total.toLocaleString()}
      </div>
    `;

    orderModal.classList.remove("hidden");
  };

  window.closeModal = function() {
    if (!orderModal) return;
    orderModal.classList.add("hidden");
  };

  // ===== Expose functions globally =====
  window.filterOrders = filterOrders;
  window.changePage = changePage;

  // ===== Safety fallback loader =====
  setTimeout(() => hideLoader(), 5000);
});
</script>
</body>
</html>
