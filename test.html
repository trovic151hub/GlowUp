<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Customer Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
.modal-bg { background: rgba(0,0,0,0.55); }

.timeline-step {
  width: 12px;
  height: 12px;
  border-radius: 9999px;
  background: #d1d5db;
  transition: background-color 0.4s ease;
}
.timeline-line {
  flex: 1;
  height: 4px;
  border-radius: 2px;
  background: #d1d5db;
  transition: background-color 0.4s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.95); }
  to { opacity: 1; transform: scale(1); }
}
.animate-fadeIn { animation: fadeIn 0.25s ease-out; }

@media (max-width: 640px) {
  main { padding: 1rem !important; }
  table { min-width: 320px; }
}
</style>
</head>

<body class="bg-gray-50 text-gray-900">

<header class="bg-gradient-to-r from-pink-300 to-pink-400 p-4 shadow-md fixed top-0 w-full flex justify-between">
  <button onclick="history.back()" class="font-bold text-lg">ðŸ‘¤ My Dashboard</button>
</header>

<main class="max-w-5xl mx-auto mt-20 p-6">
  <h2 class="font-semibold mb-4">Welcome, <span id="userName">Customer</span> ðŸ‘‹</h2>

  <div class="bg-white p-6 rounded shadow">
    <h3 class="font-semibold mb-3">ðŸ“¦ Your Orders</h3>

    <div class="flex gap-2 mb-3 overflow-x-auto">
      <button onclick="filterOrders('All')" data-status="All" class="status-btn bg-pink-500 text-white px-3 py-1 rounded">All</button>
      <button onclick="filterOrders('Pending')" data-status="Pending" class="status-btn bg-pink-100 px-3 py-1 rounded">Pending</button>
      <button onclick="filterOrders('Shipped')" data-status="Shipped" class="status-btn bg-pink-100 px-3 py-1 rounded">Shipped</button>
      <button onclick="filterOrders('Delivered')" data-status="Delivered" class="status-btn bg-pink-100 px-3 py-1 rounded">Delivered</button>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full border text-sm">
        <thead class="bg-pink-100">
          <tr>
            <th class="p-2">Date</th>
            <th class="p-2">Total</th>
            <th class="p-2">Items</th>
            <th class="p-2">Status / Action</th>
          </tr>
        </thead>
        <tbody id="orderTableBody"></tbody>
      </table>
    </div>

    <div id="paginationControls" class="flex justify-center mt-4 gap-2"></div>
  </div>
</main>

<!-- MODAL -->
<div id="orderModal" class="hidden fixed inset-0 flex items-center justify-center modal-bg z-50">
  <div class="bg-white w-11/12 max-w-lg p-6 rounded-2xl shadow-2xl animate-fadeIn max-h-[80vh] overflow-y-auto">
    <h2 class="text-xl font-bold mb-3">Order Details</h2>
    <div id="modalContent"></div>
    <div class="flex justify-end gap-2 mt-4">
      <button onclick="closeModal()" class="px-4 py-2 bg-gray-300 rounded">Close</button>
      <button id="saveBtn" class="px-4 py-2 bg-pink-500 text-white rounded hidden">Save</button>
    </div>
  </div>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const firebaseConfig = {
    apiKey: "AIzaSyDdTPmpaIPWSDWOmR-fXgvAb7hoxZUawcc",
    authDomain: "e-commerce-39c74.firebaseapp.com",
    projectId: "e-commerce-39c74"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.firestore();

  const userNameSpan = document.getElementById("userName");
  const orderTableBody = document.getElementById("orderTableBody");
  const modal = document.getElementById("orderModal");
  const modalContent = document.getElementById("modalContent");
  const saveBtn = document.getElementById("saveBtn");

  let allOrders = [];
  let currentFilter = "All";

  auth.onAuthStateChanged(user => {
    if (!user) return;
    userNameSpan.textContent = user.displayName?.split(" ")[0] || "Customer";

    db.collection("orders")
      .where("userId","==",user.uid)
      .onSnapshot(snap => {
        allOrders = snap.docs.map(d => ({
          id: d.id,
          ...d.data(),
          status: d.data().shipmentStatus || d.data().status || "Pending"
        }));
        renderOrders();
        refreshModalIfOpen();
      });
  });

  window.filterOrders = status => {
    currentFilter = status;
    document.querySelectorAll(".status-btn").forEach(btn => {
      btn.classList.toggle("bg-pink-500", btn.dataset.status === status);
      btn.classList.toggle("text-white", btn.dataset.status === status);
      btn.classList.toggle("bg-pink-100", btn.dataset.status !== status);
    });
    renderOrders();
  };

  function renderOrders(){
    orderTableBody.innerHTML = "";
    const list = currentFilter === "All"
      ? allOrders
      : allOrders.filter(o => o.status === currentFilter);

    if(!list.length){
      orderTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-gray-400">No orders</td></tr>`;
      return;
    }

    list.forEach(o => {
      const date = o.createdAt?.seconds
        ? new Date(o.createdAt.seconds * 1000).toLocaleDateString()
        : "N/A";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="p-2 text-center">${date}</td>
        <td class="p-2 text-center">â‚¦${Number(o.total || 0).toLocaleString()}</td>
        <td class="p-2 text-center">${o.items?.length || 0}</td>
        <td class="p-2 text-center">
          <span class="font-semibold">${o.status}</span>
          <button onclick="viewOrder('${o.id}')" class="ml-2 text-blue-500">View</button>
        </td>
      `;
      orderTableBody.appendChild(tr);
    });
  }

  window.viewOrder = id => {
    const order = allOrders.find(o => o.id === id);
    if(!order) return;
    modalContent.dataset.currentOrderId = id;
    modalContent.innerHTML = generateModal(order);
    modal.classList.remove("hidden");
    setTimeout(() => animateTimeline(order.status), 100);
  };

  function refreshModalIfOpen(){
    if(modal.classList.contains("hidden")) return;
    const id = modalContent.dataset.currentOrderId;
    const order = allOrders.find(o => o.id === id);
    if(order) modalContent.innerHTML = generateModal(order);
  }

  function generateModal(order){
    return `
      <h4 class="font-semibold mb-2">Order Status</h4>
      <div class="flex items-center mb-3">
        <div class="timeline-step"></div>
        <div class="timeline-line mx-2"></div>
        <div class="timeline-step"></div>
        <div class="timeline-line mx-2"></div>
        <div class="timeline-step"></div>
      </div>

      <h4 class="font-semibold mt-4">Items</h4>
      <div class="bg-gray-50 p-3 rounded space-y-2">
        ${order.items.map(i=>`
          <div class="flex justify-between bg-white p-2 rounded shadow-sm">
            <span>${i.name}</span>
            <span>${i.quantity} Ã— â‚¦${Number(i.price).toLocaleString()}</span>
          </div>`).join("")}
      </div>

      <div class="text-right font-bold mt-3">
        Total: â‚¦${Number(order.total || 0).toLocaleString()}
      </div>
    `;
  }

  function animateTimeline(status){
    const steps = ["Pending","Shipped","Delivered"];
    const index = Math.max(0, steps.indexOf(status));

    document.querySelectorAll(".timeline-step").forEach((d,i)=>{
      if(i <= index){
        d.style.background = i === 0 ? "#facc15" : i === 1 ? "#60a5fa" : "#4ade80";
      }
    });
    document.querySelectorAll(".timeline-line").forEach((l,i)=>{
      if(i < index){
        l.style.background = i === 0 ? "#facc15" : "#60a5fa";
      }
    });
  }

  window.closeModal = () => modal.classList.add("hidden");
});
</script>
</body>
</html>
